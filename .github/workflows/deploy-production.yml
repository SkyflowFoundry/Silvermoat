name: Deploy Production Stack

on:
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to clean up test stack (optional)'
        required: false
        type: string
      skip_cleanup:
        description: 'Skip test stack cleanup'
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

jobs:
  cleanup-test:
    name: Cleanup Test Stack
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number != '' && github.event.inputs.skip_cleanup != 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup AWS CDK
        uses: ./.github/actions/setup-aws-cdk

      - name: Determine stack name
        id: stack-name
        run: |
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            PR_NUM="${{ github.event.pull_request.number }}"
          else
            PR_NUM="${{ github.event.inputs.pr_number }}"
          fi
          STACK_NAME="silvermoat-test-pr-${PR_NUM}"
          echo "stack_name=${STACK_NAME}" >> $GITHUB_OUTPUT
          echo "Cleaning up stack: ${STACK_NAME}"

      - name: Check if CDK stack exists
        id: stack-check
        run: |
          if aws cloudformation describe-stacks --stack-name "${{ steps.stack-name.outputs.stack_name }}" 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "CDK stack exists, will delete"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "CDK stack does not exist, skipping deletion"
          fi

      - name: Delete stack
        if: steps.stack-check.outputs.exists == 'true'
        run: |
          echo "Deleting stack: ${{ steps.stack-name.outputs.stack_name }}"
          echo "Note: CDK destroy waits for deletion to complete automatically"
          chmod +x scripts/delete-stack.sh
          STACK_NAME="${{ steps.stack-name.outputs.stack_name }}" ./scripts/delete-stack.sh --yes

      - name: Cleanup summary
        if: always()
        run: |
          if [ "${{ steps.stack-check.outputs.exists }}" = "true" ]; then
            echo "✅ Stack ${{ steps.stack-name.outputs.stack_name }} cleanup completed"
          else
            echo "ℹ️ No stack to clean up"
          fi

  detect-changes:
    name: Detect Changed Files
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      infrastructure_changed: ${{ steps.check.outputs.infrastructure_changed }}
      ui_changed: ${{ steps.check.outputs.ui_changed }}
      stack_exists: ${{ steps.check-stack.outputs.stack_exists }}

    steps:
      - name: Checkout merged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha || github.sha }}
          fetch-depth: 2

      - name: Detect infrastructure and UI changes
        id: check
        run: |
          # For merged PRs, compare merge commit with its parent
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # Infrastructure = files that require CDK deploy (CloudFormation update)
            # Only: CDK code, Lambda code, deploy-stack.sh script
            if git diff --name-only HEAD^ HEAD | grep -E '^(cdk/|lambda/|scripts/deploy-stack\.sh)'; then
              echo "infrastructure_changed=true" >> $GITHUB_OUTPUT
              echo "✅ Infrastructure files changed (requires CDK deploy)"
            else
              echo "infrastructure_changed=false" >> $GITHUB_OUTPUT
              echo "ℹ️ No infrastructure changes detected"
            fi

            # UI changes
            if git diff --name-only HEAD^ HEAD | grep -E '^(ui/|scripts/generate-architecture-diagram\.py|scripts/deploy-ui\.sh)'; then
              echo "ui_changed=true" >> $GITHUB_OUTPUT
              echo "✅ UI files changed (requires rebuild)"
            else
              echo "ui_changed=false" >> $GITHUB_OUTPUT
              echo "ℹ️ No UI changes detected"
            fi
          else
            # Manual dispatch - deploy everything
            echo "infrastructure_changed=true" >> $GITHUB_OUTPUT
            echo "ui_changed=true" >> $GITHUB_OUTPUT
            echo "Manual dispatch - will deploy infrastructure and UI"
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Check if CDK stack exists
        id: check-stack
        run: |
          if aws cloudformation describe-stacks --stack-name silvermoat >/dev/null 2>&1; then
            echo "stack_exists=true" >> $GITHUB_OUTPUT
            echo "✅ CDK stack 'silvermoat' exists"
          else
            echo "stack_exists=false" >> $GITHUB_OUTPUT
            echo "ℹ️ CDK stack 'silvermoat' does not exist"
          fi

  deploy-stack:
    name: Deploy Infra
    needs: [detect-changes]
    if: |
      always() &&
      needs.detect-changes.result == 'success' &&
      (needs.detect-changes.outputs.infrastructure_changed == 'true' ||
       needs.detect-changes.outputs.stack_exists == 'false')
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install dependencies
        uses: ./.github/actions/install-deps
        with:
          install-ui: 'false'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup AWS CDK
        uses: ./.github/actions/setup-aws-cdk

      - name: Bootstrap CDK
        uses: ./.github/actions/bootstrap-cdk

      - name: Deploy production stack
        env:
          STACK_NAME: silvermoat
          APP_NAME: silvermoat
          STAGE_NAME: prod
          UI_SEEDING_MODE: external
          CREATE_CLOUDFRONT: true
          DOMAIN_NAME: silvermoat.net
        run: |
          echo "Deploying production stack: silvermoat"
          echo "Note: Clean deployment with full CloudFront + custom domain"
          chmod +x scripts/deploy-stack.sh
          ./scripts/deploy-stack.sh

  configure-dns:
    name: Configure DNS
    needs: [deploy-stack]
    if: always() && needs.deploy-stack.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup ACM validation (automatic)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          STACK_NAME: silvermoat
        run: |
          echo "Setting up ACM certificate DNS validation..."
          chmod +x scripts/setup-acm-validation.sh
          ./scripts/setup-acm-validation.sh || echo "⚠️ ACM validation setup failed or not needed"

      - name: Update Cloudflare DNS
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          STACK_NAME: silvermoat
          DOMAIN_NAME: silvermoat.net
        run: |
          echo "Running smart DNS update..."
          chmod +x scripts/update-cloudflare-dns.sh
          ./scripts/update-cloudflare-dns.sh

  deploy-ui:
    name: Deploy UI
    needs: [detect-changes, deploy-stack, configure-dns]
    if: |
      always() &&
      (needs.deploy-stack.result == 'success' || needs.deploy-stack.result == 'skipped') &&
      (needs.configure-dns.result == 'success' || needs.configure-dns.result == 'skipped') &&
      (needs.deploy-stack.result == 'success' || needs.detect-changes.outputs.ui_changed == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      api_url: ${{ steps.stack-outputs.outputs.api_url }}
      web_url: ${{ steps.stack-outputs.outputs.web_url }}
      cloudfront_url: ${{ steps.stack-outputs.outputs.cloudfront_url }}
      cloudfront_id: ${{ steps.cloudfront.outputs.distribution_id }}
      ui_deployed: 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get CloudFront distribution ID
        id: cloudfront
        run: |
          # Get distribution ID from CDK stack output
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name silvermoat \
            --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionId`].OutputValue' \
            --output text 2>/dev/null || echo "")

          # Fallback to resource query for backwards compatibility
          if [ -z "$DISTRIBUTION_ID" ] || [ "$DISTRIBUTION_ID" == "None" ]; then
            echo "Output not found, trying resource query (fallback)..."
            DISTRIBUTION_ID=$(aws cloudformation describe-stack-resources \
              --stack-name silvermoat \
              --query 'StackResources[?ResourceType==`AWS::CloudFront::Distribution`].PhysicalResourceId | [0]' \
              --output text 2>/dev/null || echo "")
          fi

          if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ]; then
            echo "distribution_id=${DISTRIBUTION_ID}" >> $GITHUB_OUTPUT
            echo "CloudFront Distribution ID: ${DISTRIBUTION_ID}"
          else
            echo "No CloudFront distribution found"
          fi

      - name: Build and deploy React UI
        env:
          STACK_NAME: silvermoat
        run: |
          echo "Building and deploying React UI..."
          chmod +x scripts/deploy-ui.sh
          ./scripts/deploy-ui.sh

      - name: Start CloudFront cache invalidation
        id: invalidation
        if: steps.cloudfront.outputs.distribution_id != ''
        run: |
          echo "Starting CloudFront cache invalidation..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ steps.cloudfront.outputs.distribution_id }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          echo "invalidation_id=${INVALIDATION_ID}" >> $GITHUB_OUTPUT
          echo "Cache invalidation started: ${INVALIDATION_ID}"

      - name: Get stack outputs
        id: stack-outputs
        run: |
          # Get all outputs as JSON
          OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name silvermoat \
            --query 'Stacks[0].Outputs' \
            --output json)

          # Extract URLs
          API_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="ApiBaseUrl") | .OutputValue')
          CF_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="CloudFrontUrl") | .OutputValue')
          CUSTOM_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="CustomDomainUrl") | .OutputValue')

          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "cloudfront_url=${CF_URL}" >> $GITHUB_OUTPUT
          echo "web_url=${CUSTOM_URL:-$CF_URL}" >> $GITHUB_OUTPUT

          echo "API URL: ${API_URL}"
          echo "CloudFront URL: ${CF_URL}"
          echo "Custom Domain URL: ${CUSTOM_URL}"

      - name: Quick health check
        run: |
          API_URL="${{ steps.stack-outputs.outputs.api_url }}"
          echo "Running quick health check against ${API_URL}..."

          if curl -f -s "${API_URL}/" > /dev/null; then
            echo "✅ API is responding"
          else
            echo "❌ API not responding, deployment may have failed"
            exit 1
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "==================================="
          echo "Production Deployment Summary"
          echo "==================================="
          echo "Stack: silvermoat"
          echo "UI deployment skipped: ${{ steps.check-ui.outputs.skip_ui }}"
          echo "API: ${{ steps.stack-outputs.outputs.api_url }}"
          echo "CloudFront: ${{ steps.stack-outputs.outputs.cloudfront_url }}"
          echo "Custom Domain: ${{ steps.stack-outputs.outputs.web_url }}"
          echo "==================================="
          if [ "${{ steps.check-ui.outputs.skip_ui }}" = "true" ]; then
            echo "⚡ UI unchanged - saved ~2-3 minutes!"
          fi

  # Phase 1: Comprehensive Test Suite (Matrix Strategy)
  tests:
    name: Tests
    needs: [deploy-ui]
    if: always() && needs.deploy-ui.result == 'success'
    uses: ./.github/workflows/test-suite.yml
    with:
      stack_name: silvermoat
      api_url: ${{ needs.deploy-ui.outputs.api_url }}
      web_url: ${{ needs.deploy-ui.outputs.web_url }}
      environment: 'production'
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  clear-and-seed-data:
    name: Seed Demo Data
    needs: [deploy-ui, tests]
    if: always() && needs.deploy-ui.result == 'success' && needs.tests.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clear and seed demo data
        uses: ./.github/actions/clear-and-seed-data
        with:
          api-base-url: ${{ needs.deploy-ui.outputs.api_url }}
