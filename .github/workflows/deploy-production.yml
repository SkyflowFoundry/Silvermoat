name: Deploy Production Stack (Multi-Vertical)

on:
  pull_request:
    types: [closed]
    branches: [main]
    paths:
      - 'cdk/**'
      - 'lambda/**'
      - 'ui-insurance/**'
      - 'ui-retail/**'
      - 'ui-healthcare/**'
      - 'ui-landing/**'
      - 'tests/e2e/**'
      - 'scripts/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to clean up test stack (optional)'
        required: false
        type: string
      skip_cleanup:
        description: 'Skip test stack cleanup'
        type: boolean
        default: false
      force_deploy:
        description: 'Run all stages/jobs for all verticals (infrastructure, UI, tests, seeding)'
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

jobs:
  cleanup-test:
    name: Cleanup Test Stacks
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number != '' && github.event.inputs.skip_cleanup != 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        vertical: [insurance, retail, healthcare, landing]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup AWS CDK
        uses: ./.github/actions/setup-aws-cdk

      - name: Determine stack name
        id: stack-name
        run: |
          PR_NUM="${{ github.event.pull_request.number || github.event.inputs.pr_number }}"
          STACK_NAME="silvermoat-test-pr-${PR_NUM}-${{ matrix.vertical }}"
          echo "stack_name=${STACK_NAME}" >> $GITHUB_OUTPUT
          echo "Cleaning up stack: ${STACK_NAME}"

      - name: Check if CDK stack exists
        id: stack-check
        run: |
          if aws cloudformation describe-stacks --stack-name "${{ steps.stack-name.outputs.stack_name }}" 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "CDK stack exists, will delete"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "CDK stack does not exist, skipping deletion"
          fi

      - name: Delete ${{ matrix.vertical }} stack
        if: steps.stack-check.outputs.exists == 'true'
        run: |
          echo "Deleting stack: ${{ steps.stack-name.outputs.stack_name }}"
          chmod +x scripts/delete-stack.sh
          STACK_NAME="${{ steps.stack-name.outputs.stack_name }}" ./scripts/delete-stack.sh --yes

      - name: Cleanup summary
        if: always()
        run: |
          if [ "${{ steps.stack-check.outputs.exists }}" = "true" ]; then
            echo "‚úÖ Stack ${{ steps.stack-name.outputs.stack_name }} cleanup completed"
          else
            echo "‚ÑπÔ∏è No ${{ matrix.vertical }} stack to clean up"
          fi

  detect-changes:
    name: Detect Changed Files
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      infrastructure_changed: ${{ steps.check.outputs.infrastructure_changed }}
      ui_changed: ${{ steps.check.outputs.ui_changed }}
      insurance_stack_exists: ${{ steps.check-stacks.outputs.insurance_exists }}
      retail_stack_exists: ${{ steps.check-stacks.outputs.retail_exists }}
      healthcare_stack_exists: ${{ steps.check-stacks.outputs.healthcare_exists }}
      landing_stack_exists: ${{ steps.check-stacks.outputs.landing_exists }}

    steps:
      - name: Checkout merged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha || github.sha }}
          fetch-depth: 2

      - name: Detect infrastructure and UI changes
        id: check
        uses: ./.github/actions/detect-changes
        with:
          force_deploy: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.force_deploy == 'true') && 'true' || 'false' }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Check if stacks exist
        id: check-stacks
        run: |
          # Check insurance stack
          if aws cloudformation describe-stacks --stack-name "silvermoat-insurance" >/dev/null 2>&1; then
            echo "insurance_exists=true" >> $GITHUB_OUTPUT
            echo "Insurance stack exists: silvermoat-insurance"
          else
            echo "insurance_exists=false" >> $GITHUB_OUTPUT
            echo "Insurance stack does not exist: silvermoat-insurance"
          fi

          # Check retail stack
          if aws cloudformation describe-stacks --stack-name "silvermoat-retail" >/dev/null 2>&1; then
            echo "retail_exists=true" >> $GITHUB_OUTPUT
            echo "Retail stack exists: silvermoat-retail"
          else
            echo "retail_exists=false" >> $GITHUB_OUTPUT
            echo "Retail stack does not exist: silvermoat-retail"
          fi

          # Check healthcare stack
          if aws cloudformation describe-stacks --stack-name "silvermoat-healthcare" >/dev/null 2>&1; then
            echo "healthcare_exists=true" >> $GITHUB_OUTPUT
            echo "Healthcare stack exists: silvermoat-healthcare"
          else
            echo "healthcare_exists=false" >> $GITHUB_OUTPUT
            echo "Healthcare stack does not exist: silvermoat-healthcare"
          fi

          # Check landing stack
          if aws cloudformation describe-stacks --stack-name "silvermoat-landing" >/dev/null 2>&1; then
            echo "landing_exists=true" >> $GITHUB_OUTPUT
            echo "Landing stack exists: silvermoat-landing"
          else
            echo "landing_exists=false" >> $GITHUB_OUTPUT
            echo "Landing stack does not exist: silvermoat-landing"
          fi

  # ========================================
  # Insurance Vertical Pipeline
  # ========================================

  deploy-insurance-infra:
    name: Deploy Insurance Infra
    needs: [detect-changes]
    if: |
      always() &&
      needs.detect-changes.result == 'success' &&
      (needs.detect-changes.outputs.infrastructure_changed == 'true' ||
       needs.detect-changes.outputs.insurance_lambda_changed == 'true' ||
       needs.detect-changes.outputs.insurance_stack_exists == 'false')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      stack_name: ${{ steps.deploy.outputs.stack_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup infrastructure deployment
        uses: ./.github/actions/setup-infra-deploy
        with:
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

      - name: Deploy insurance production stack
        id: deploy
        env:
          STACK_NAME: silvermoat
          VERTICAL: insurance
          STAGE_NAME: prod
          CREATE_CLOUDFRONT: true
          DOMAIN_NAME: "*.silvermoat.net"
        run: |
          echo "Deploying insurance production stack: silvermoat-insurance"
          chmod +x scripts/deploy-stack.sh
          ./scripts/deploy-stack.sh
          echo "stack_name=silvermoat-insurance" >> $GITHUB_OUTPUT

  deploy-retail-infra:
    name: Deploy Retail Infra
    needs: [detect-changes]
    if: |
      always() &&
      needs.detect-changes.result == 'success' &&
      (needs.detect-changes.outputs.infrastructure_changed == 'true' ||
       needs.detect-changes.outputs.retail_lambda_changed == 'true' ||
       needs.detect-changes.outputs.retail_stack_exists == 'false')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      stack_name: ${{ steps.deploy.outputs.stack_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup infrastructure deployment
        uses: ./.github/actions/setup-infra-deploy
        with:
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

      - name: Deploy retail production stack
        id: deploy
        env:
          STACK_NAME: silvermoat
          VERTICAL: retail
          STAGE_NAME: prod
          CREATE_CLOUDFRONT: true
          DOMAIN_NAME: "*.silvermoat.net"
        run: |
          echo "Deploying retail production stack: silvermoat-retail"
          chmod +x scripts/deploy-stack.sh
          ./scripts/deploy-stack.sh
          echo "stack_name=silvermoat-retail" >> $GITHUB_OUTPUT

  deploy-healthcare-infra:
    name: Deploy Healthcare Infra
    needs: [detect-changes]
    if: |
      always() &&
      needs.detect-changes.result == 'success' &&
      (needs.detect-changes.outputs.infrastructure_changed == 'true' ||
       needs.detect-changes.outputs.healthcare_lambda_changed == 'true' ||
       needs.detect-changes.outputs.healthcare_stack_exists == 'false')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      stack_name: ${{ steps.deploy.outputs.stack_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup infrastructure deployment
        uses: ./.github/actions/setup-infra-deploy
        with:
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

      - name: Deploy healthcare production stack
        id: deploy
        env:
          STACK_NAME: silvermoat
          VERTICAL: healthcare
          STAGE_NAME: prod
          CREATE_CLOUDFRONT: true
          DOMAIN_NAME: "*.silvermoat.net"
        run: |
          echo "Deploying healthcare production stack: silvermoat-healthcare"
          chmod +x scripts/deploy-stack.sh
          ./scripts/deploy-stack.sh
          echo "stack_name=silvermoat-healthcare" >> $GITHUB_OUTPUT

  deploy-landing-infra:
    name: Deploy Landing Infra
    needs: [detect-changes]
    if: |
      always() &&
      needs.detect-changes.result == 'success' &&
      (needs.detect-changes.outputs.infrastructure_changed == 'true' ||
       needs.detect-changes.outputs.landing_lambda_changed == 'true' ||
       needs.detect-changes.outputs.landing_stack_exists == 'false')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      stack_name: ${{ steps.deploy.outputs.stack_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup infrastructure deployment
        uses: ./.github/actions/setup-infra-deploy
        with:
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

      - name: Deploy landing production stack
        id: deploy
        env:
          STACK_NAME: silvermoat
          VERTICAL: landing
          STAGE_NAME: prod
          CREATE_CLOUDFRONT: true
          DOMAIN_NAME: silvermoat.net
        run: |
          echo "Deploying landing production stack: silvermoat-landing"
          chmod +x scripts/deploy-stack.sh
          ./scripts/deploy-stack.sh
          echo "stack_name=silvermoat-landing" >> $GITHUB_OUTPUT

  configure-insurance-dns:
    name: Configure Insurance DNS
    needs: [deploy-insurance-infra]
    if: always() && needs.deploy-insurance-infra.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup ACM validation (insurance)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          STACK_NAME: silvermoat-insurance
        run: |
          echo "Setting up ACM certificate DNS validation for insurance..."
          chmod +x scripts/setup-acm-validation.sh
          ./scripts/setup-acm-validation.sh || echo "‚ö†Ô∏è ACM validation setup failed or not needed"

      - name: Update Cloudflare DNS (insurance)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          STACK_NAME: silvermoat-insurance
          DOMAIN_NAME: silvermoat.net
        run: |
          echo "Running smart DNS update for insurance..."
          chmod +x scripts/update-cloudflare-dns.sh
          ./scripts/update-cloudflare-dns.sh

  configure-retail-dns:
    name: Configure Retail DNS
    needs: [deploy-retail-infra]
    if: always() && needs.deploy-retail-infra.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup ACM validation (retail)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          STACK_NAME: silvermoat-retail
        run: |
          echo "Setting up ACM certificate DNS validation for retail..."
          chmod +x scripts/setup-acm-validation.sh
          ./scripts/setup-acm-validation.sh || echo "‚ö†Ô∏è ACM validation setup failed or not needed"

      - name: Update Cloudflare DNS (retail)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          STACK_NAME: silvermoat-retail
          DOMAIN_NAME: silvermoat.net
        run: |
          echo "Running smart DNS update for retail..."
          chmod +x scripts/update-cloudflare-dns.sh
          ./scripts/update-cloudflare-dns.sh

  configure-healthcare-dns:
    name: Configure Healthcare DNS
    needs: [deploy-healthcare-infra]
    if: always() && needs.deploy-healthcare-infra.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup ACM validation (healthcare)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          STACK_NAME: silvermoat-healthcare
        run: |
          echo "Setting up ACM certificate DNS validation for healthcare..."
          chmod +x scripts/setup-acm-validation.sh
          ./scripts/setup-acm-validation.sh || echo "‚ö†Ô∏è ACM validation setup failed or not needed"

      - name: Update Cloudflare DNS (healthcare)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          STACK_NAME: silvermoat-healthcare
          DOMAIN_NAME: silvermoat.net
        run: |
          echo "Running smart DNS update for healthcare..."
          chmod +x scripts/update-cloudflare-dns.sh
          ./scripts/update-cloudflare-dns.sh

  configure-landing-dns:
    name: Configure Landing DNS
    needs: [deploy-landing-infra]
    if: always() && needs.deploy-landing-infra.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup ACM validation (landing)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          STACK_NAME: silvermoat-landing
        run: |
          echo "Setting up ACM certificate DNS validation for landing..."
          chmod +x scripts/setup-acm-validation.sh
          ./scripts/setup-acm-validation.sh || echo "‚ö†Ô∏è ACM validation setup failed or not needed"

      - name: Update Cloudflare DNS (landing)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          STACK_NAME: silvermoat-landing
          DOMAIN_NAME: silvermoat.net
        run: |
          echo "Running smart DNS update for landing (apex domain)..."
          chmod +x scripts/update-cloudflare-dns.sh
          ./scripts/update-cloudflare-dns.sh

  deploy-insurance-ui:
    name: Deploy Insurance UI
    needs: [detect-changes, deploy-insurance-infra, configure-insurance-dns]
    if: |
      always() &&
      (needs.deploy-insurance-infra.result == 'success' || needs.deploy-insurance-infra.result == 'skipped') &&
      (needs.configure-insurance-dns.result == 'success' || needs.configure-insurance-dns.result == 'skipped') &&
      (needs.deploy-insurance-infra.result == 'success' || needs.detect-changes.outputs.ui_changed == 'true' || needs.detect-changes.outputs.insurance_ui_changed == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      api_url: ${{ steps.stack-outputs.outputs.api_url }}
      web_url: ${{ steps.stack-outputs.outputs.web_url }}
      cloudfront_url: ${{ steps.stack-outputs.outputs.cloudfront_url }}
      cloudfront_id: ${{ steps.cloudfront.outputs.distribution_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get CloudFront distribution ID
        id: cloudfront
        run: |
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name silvermoat-insurance \
            --query 'Stacks[0].Outputs[?OutputKey==`InsuranceCloudFrontDistributionId`].OutputValue' \
            --output text 2>/dev/null || echo "")

          if [ -z "$DISTRIBUTION_ID" ] || [ "$DISTRIBUTION_ID" == "None" ]; then
            echo "Output not found, trying resource query..."
            DISTRIBUTION_ID=$(aws cloudformation describe-stack-resources \
              --stack-name silvermoat-insurance \
              --query 'StackResources[?ResourceType==`AWS::CloudFront::Distribution`].PhysicalResourceId | [0]' \
              --output text 2>/dev/null || echo "")
          fi

          if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ]; then
            echo "distribution_id=${DISTRIBUTION_ID}" >> $GITHUB_OUTPUT
            echo "CloudFront Distribution ID: ${DISTRIBUTION_ID}"
          else
            echo "No CloudFront distribution found"
          fi

      - name: Build and deploy insurance UI
        env:
          STACK_NAME: silvermoat
          VERTICAL: insurance
        run: |
          echo "Building and deploying insurance UI..."
          chmod +x scripts/deploy-ui.sh
          ./scripts/deploy-ui.sh

      - name: Start CloudFront cache invalidation
        id: invalidation
        if: steps.cloudfront.outputs.distribution_id != ''
        run: |
          echo "Starting CloudFront cache invalidation..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ steps.cloudfront.outputs.distribution_id }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          echo "invalidation_id=${INVALIDATION_ID}" >> $GITHUB_OUTPUT
          echo "Cache invalidation started: ${INVALIDATION_ID}"

      - name: Get stack outputs
        id: stack-outputs
        run: |
          OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name silvermoat-insurance \
            --query 'Stacks[0].Outputs' \
            --output json)

          API_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="InsuranceApiUrl") | .OutputValue')
          CF_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="InsuranceCloudFrontUrl") | .OutputValue')
          CUSTOM_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="InsuranceDomainUrl") | .OutputValue')

          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "cloudfront_url=${CF_URL}" >> $GITHUB_OUTPUT
          echo "web_url=${CUSTOM_URL:-$CF_URL}" >> $GITHUB_OUTPUT

          echo "API URL: ${API_URL}"
          echo "CloudFront URL: ${CF_URL}"
          echo "Custom Domain URL: ${CUSTOM_URL}"

      - name: Quick health check
        run: |
          API_URL="${{ steps.stack-outputs.outputs.api_url }}"
          echo "Running quick health check against ${API_URL}..."

          if curl -f -s "${API_URL}/" > /dev/null; then
            echo "‚úÖ Insurance API is responding"
          else
            echo "‚ùå Insurance API not responding, deployment may have failed"
            exit 1
          fi

  deploy-retail-ui:
    name: Deploy Retail UI
    needs: [detect-changes, deploy-retail-infra, configure-retail-dns]
    if: |
      always() &&
      (needs.deploy-retail-infra.result == 'success' || needs.deploy-retail-infra.result == 'skipped') &&
      (needs.configure-retail-dns.result == 'success' || needs.configure-retail-dns.result == 'skipped') &&
      (needs.deploy-retail-infra.result == 'success' || needs.detect-changes.outputs.ui_changed == 'true' || needs.detect-changes.outputs.retail_ui_changed == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      api_url: ${{ steps.stack-outputs.outputs.api_url }}
      web_url: ${{ steps.stack-outputs.outputs.web_url }}
      cloudfront_url: ${{ steps.stack-outputs.outputs.cloudfront_url }}
      cloudfront_id: ${{ steps.cloudfront.outputs.distribution_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get CloudFront distribution ID
        id: cloudfront
        run: |
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name silvermoat-retail \
            --query 'Stacks[0].Outputs[?OutputKey==`RetailCloudFrontDistributionId`].OutputValue' \
            --output text 2>/dev/null || echo "")

          if [ -z "$DISTRIBUTION_ID" ] || [ "$DISTRIBUTION_ID" == "None" ]; then
            echo "Output not found, trying resource query..."
            DISTRIBUTION_ID=$(aws cloudformation describe-stack-resources \
              --stack-name silvermoat-retail \
              --query 'StackResources[?ResourceType==`AWS::CloudFront::Distribution`].PhysicalResourceId | [0]' \
              --output text 2>/dev/null || echo "")
          fi

          if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ]; then
            echo "distribution_id=${DISTRIBUTION_ID}" >> $GITHUB_OUTPUT
            echo "CloudFront Distribution ID: ${DISTRIBUTION_ID}"
          else
            echo "No CloudFront distribution found"
          fi

      - name: Build and deploy retail UI
        env:
          STACK_NAME: silvermoat
          VERTICAL: retail
        run: |
          echo "Building and deploying retail UI..."
          chmod +x scripts/deploy-ui.sh
          ./scripts/deploy-ui.sh

      - name: Start CloudFront cache invalidation
        id: invalidation
        if: steps.cloudfront.outputs.distribution_id != ''
        run: |
          echo "Starting CloudFront cache invalidation..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ steps.cloudfront.outputs.distribution_id }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          echo "invalidation_id=${INVALIDATION_ID}" >> $GITHUB_OUTPUT
          echo "Cache invalidation started: ${INVALIDATION_ID}"

      - name: Get stack outputs
        id: stack-outputs
        run: |
          OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name silvermoat-retail \
            --query 'Stacks[0].Outputs' \
            --output json)

          API_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="RetailApiUrl") | .OutputValue')
          CF_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="RetailCloudFrontUrl") | .OutputValue')
          CUSTOM_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="RetailDomainUrl") | .OutputValue')

          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "cloudfront_url=${CF_URL}" >> $GITHUB_OUTPUT
          echo "web_url=${CUSTOM_URL:-$CF_URL}" >> $GITHUB_OUTPUT

          echo "API URL: ${API_URL}"
          echo "CloudFront URL: ${CF_URL}"
          echo "Custom Domain URL: ${CUSTOM_URL}"

      - name: Quick health check
        run: |
          API_URL="${{ steps.stack-outputs.outputs.api_url }}"
          echo "Running quick health check against ${API_URL}..."

          if curl -f -s "${API_URL}/" > /dev/null; then
            echo "‚úÖ Retail API is responding"
          else
            echo "‚ùå Retail API not responding, deployment may have failed"
            exit 1
          fi

  deploy-healthcare-ui:
    name: Deploy Healthcare UI
    needs: [detect-changes, deploy-healthcare-infra, configure-healthcare-dns]
    if: |
      always() &&
      (needs.deploy-healthcare-infra.result == 'success' || needs.deploy-healthcare-infra.result == 'skipped') &&
      (needs.configure-healthcare-dns.result == 'success' || needs.configure-healthcare-dns.result == 'skipped') &&
      (needs.deploy-healthcare-infra.result == 'success' || needs.detect-changes.outputs.ui_changed == 'true' || needs.detect-changes.outputs.healthcare_ui_changed == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      api_url: ${{ steps.stack-outputs.outputs.api_url }}
      web_url: ${{ steps.stack-outputs.outputs.web_url }}
      cloudfront_url: ${{ steps.stack-outputs.outputs.cloudfront_url }}
      cloudfront_id: ${{ steps.cloudfront.outputs.distribution_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get CloudFront distribution ID
        id: cloudfront
        run: |
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name silvermoat-healthcare \
            --query 'Stacks[0].Outputs[?OutputKey==`HealthcareCloudFrontDistributionId`].OutputValue' \
            --output text 2>/dev/null || echo "")

          if [ -z "$DISTRIBUTION_ID" ] || [ "$DISTRIBUTION_ID" == "None" ]; then
            echo "Output not found, trying resource query..."
            DISTRIBUTION_ID=$(aws cloudformation describe-stack-resources \
              --stack-name silvermoat-healthcare \
              --query 'StackResources[?ResourceType==`AWS::CloudFront::Distribution`].PhysicalResourceId | [0]' \
              --output text 2>/dev/null || echo "")
          fi

          if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ]; then
            echo "distribution_id=${DISTRIBUTION_ID}" >> $GITHUB_OUTPUT
            echo "CloudFront Distribution ID: ${DISTRIBUTION_ID}"
          else
            echo "No CloudFront distribution found"
          fi

      - name: Build and deploy healthcare UI
        env:
          STACK_NAME: silvermoat
          VERTICAL: healthcare
        run: |
          echo "Building and deploying healthcare UI..."
          chmod +x scripts/deploy-ui.sh
          ./scripts/deploy-ui.sh

      - name: Start CloudFront cache invalidation
        id: invalidation
        if: steps.cloudfront.outputs.distribution_id != ''
        run: |
          echo "Starting CloudFront cache invalidation..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ steps.cloudfront.outputs.distribution_id }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          echo "invalidation_id=${INVALIDATION_ID}" >> $GITHUB_OUTPUT
          echo "Cache invalidation started: ${INVALIDATION_ID}"

      - name: Get stack outputs
        id: stack-outputs
        run: |
          OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name silvermoat-healthcare \
            --query 'Stacks[0].Outputs' \
            --output json)

          API_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="HealthcareApiUrl") | .OutputValue')
          CF_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="HealthcareCloudFrontUrl") | .OutputValue')
          CUSTOM_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="HealthcareDomainUrl") | .OutputValue')

          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "cloudfront_url=${CF_URL}" >> $GITHUB_OUTPUT
          echo "web_url=${CUSTOM_URL:-$CF_URL}" >> $GITHUB_OUTPUT

          echo "API URL: ${API_URL}"
          echo "CloudFront URL: ${CF_URL}"
          echo "Custom Domain URL: ${CUSTOM_URL}"

      - name: Quick health check
        run: |
          API_URL="${{ steps.stack-outputs.outputs.api_url }}"
          echo "Running quick health check against ${API_URL}..."

          if curl -f -s "${API_URL}/" > /dev/null; then
            echo "‚úÖ Healthcare API is responding"
          else
            echo "‚ùå Healthcare API not responding, deployment may have failed"
            exit 1
          fi

  e2e-healthcare:
    name: Healthcare E2E Tests
    needs: [detect-changes, deploy-healthcare-infra, deploy-healthcare-ui]
    if: |
      always() &&
      (needs.deploy-healthcare-ui.result == 'success' ||
       needs.detect-changes.outputs.healthcare_stack_exists == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run healthcare E2E tests
        uses: ./.github/actions/run-e2e-tests
        with:
          vertical: healthcare
          web-url: ${{ needs.deploy-healthcare-ui.outputs.web_url }}
          api-url: ${{ needs.deploy-healthcare-ui.outputs.api_url }}
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

  seed-healthcare-data:
    name: Seed Healthcare Data
    needs: [deploy-healthcare-ui, e2e-healthcare]
    if: |
      always() &&
      needs.deploy-healthcare-ui.result == 'success' &&
      (needs.e2e-healthcare.result == 'success' || needs.e2e-healthcare.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Seed healthcare demo data
        uses: ./.github/actions/clear-and-seed-data
        with:
          api-base-url: ${{ needs.deploy-healthcare-ui.outputs.api_url }}
          vertical: healthcare

  deploy-landing-ui:
    name: Deploy Landing UI
    needs: [detect-changes, deploy-landing-infra, configure-landing-dns, deploy-insurance-infra, deploy-retail-infra, deploy-healthcare-infra]
    if: |
      always() &&
      (needs.deploy-landing-infra.result == 'success' || needs.deploy-landing-infra.result == 'skipped') &&
      (needs.configure-landing-dns.result == 'success' || needs.configure-landing-dns.result == 'skipped') &&
      (needs.deploy-landing-infra.result == 'success' || needs.detect-changes.outputs.ui_changed == 'true' || needs.detect-changes.outputs.landing_ui_changed == 'true') &&
      (needs.deploy-insurance-infra.result == 'success' || needs.deploy-insurance-infra.result == 'skipped') &&
      (needs.deploy-retail-infra.result == 'success' || needs.deploy-retail-infra.result == 'skipped') &&
      (needs.deploy-healthcare-infra.result == 'success' || needs.deploy-healthcare-infra.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      web_url: ${{ steps.stack-outputs.outputs.web_url }}
      cloudfront_url: ${{ steps.stack-outputs.outputs.cloudfront_url }}
      cloudfront_id: ${{ steps.cloudfront.outputs.distribution_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: Install Graphviz for diagram generation
        run: sudo apt-get update && sudo apt-get install -y graphviz

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get CloudFront distribution ID
        id: cloudfront
        run: |
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name silvermoat-landing \
            --query 'Stacks[0].Outputs[?OutputKey==`LandingCloudFrontDistributionId`].OutputValue' \
            --output text 2>/dev/null || echo "")

          if [ -z "$DISTRIBUTION_ID" ] || [ "$DISTRIBUTION_ID" == "None" ]; then
            echo "Output not found, trying resource query..."
            DISTRIBUTION_ID=$(aws cloudformation describe-stack-resources \
              --stack-name silvermoat-landing \
              --query 'StackResources[?ResourceType==`AWS::CloudFront::Distribution`].PhysicalResourceId | [0]' \
              --output text 2>/dev/null || echo "")
          fi

          if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ]; then
            echo "distribution_id=${DISTRIBUTION_ID}" >> $GITHUB_OUTPUT
            echo "CloudFront Distribution ID: ${DISTRIBUTION_ID}"
          else
            echo "No CloudFront distribution found"
          fi

      - name: Build and deploy landing UI
        env:
          STACK_NAME: silvermoat
          VERTICAL: landing
        run: |
          echo "Building and deploying landing UI..."
          chmod +x scripts/deploy-ui.sh
          ./scripts/deploy-ui.sh

      - name: Start CloudFront cache invalidation
        id: invalidation
        if: steps.cloudfront.outputs.distribution_id != ''
        run: |
          echo "Starting CloudFront cache invalidation..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ steps.cloudfront.outputs.distribution_id }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          echo "invalidation_id=${INVALIDATION_ID}" >> $GITHUB_OUTPUT
          echo "Cache invalidation started: ${INVALIDATION_ID}"

      - name: Get stack outputs
        id: stack-outputs
        run: |
          OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name silvermoat-landing \
            --query 'Stacks[0].Outputs' \
            --output json)

          CF_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="LandingCloudFrontUrl") | .OutputValue')
          CUSTOM_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="LandingDomainUrl") | .OutputValue')

          echo "cloudfront_url=${CF_URL}" >> $GITHUB_OUTPUT
          echo "web_url=${CUSTOM_URL:-$CF_URL}" >> $GITHUB_OUTPUT

          echo "CloudFront URL: ${CF_URL}"
          echo "Custom Domain URL: ${CUSTOM_URL}"

  # ========================================
  # E2E Tests Matrix (Parallelized by Category)
  # ========================================

  e2e-tests:
    name: E2E Tests (${{ matrix.vertical }} - ${{ matrix.category }})
    needs: [detect-changes, deploy-insurance-infra, deploy-insurance-ui, deploy-retail-infra, deploy-retail-ui, deploy-landing-infra, deploy-landing-ui]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        include:
          # Insurance tests (2 smoke, 3 api, 4 ui, 1 lifecycle)
          - vertical: insurance
            category: smoke
            deploy_job: deploy-insurance-ui
            stack_check: insurance_stack_exists
          - vertical: insurance
            category: api
            deploy_job: deploy-insurance-ui
            stack_check: insurance_stack_exists
          - vertical: insurance
            category: ui
            deploy_job: deploy-insurance-ui
            stack_check: insurance_stack_exists
          - vertical: insurance
            category: lifecycle
            deploy_job: deploy-insurance-ui
            stack_check: insurance_stack_exists

          # Retail tests (5 smoke, 5 api, 2 ui, 1 lifecycle)
          - vertical: retail
            category: smoke
            deploy_job: deploy-retail-ui
            stack_check: retail_stack_exists
          - vertical: retail
            category: api
            deploy_job: deploy-retail-ui
            stack_check: retail_stack_exists
          - vertical: retail
            category: ui
            deploy_job: deploy-retail-ui
            stack_check: retail_stack_exists
          - vertical: retail
            category: lifecycle
            deploy_job: deploy-retail-ui
            stack_check: retail_stack_exists

          # Landing tests (4 smoke, 3 ui)
          - vertical: landing
            category: smoke
            deploy_job: deploy-landing-ui
            stack_check: landing_stack_exists
          - vertical: landing
            category: ui
            deploy_job: deploy-landing-ui
            stack_check: landing_stack_exists

    steps:
      - name: Check if tests should run
        id: should_run
        run: |
          # Run tests if deployment succeeded OR stack already exists
          VERTICAL="${{ matrix.vertical }}"

          # Get deployment result and stack existence for this vertical
          if [[ "$VERTICAL" == "insurance" ]]; then
            DEPLOY_RESULT="${{ needs.deploy-insurance-ui.result }}"
            STACK_EXISTS="${{ needs.detect-changes.outputs.insurance_stack_exists }}"
          elif [[ "$VERTICAL" == "retail" ]]; then
            DEPLOY_RESULT="${{ needs.deploy-retail-ui.result }}"
            STACK_EXISTS="${{ needs.detect-changes.outputs.retail_stack_exists }}"
          elif [[ "$VERTICAL" == "landing" ]]; then
            DEPLOY_RESULT="${{ needs.deploy-landing-ui.result }}"
            STACK_EXISTS="${{ needs.detect-changes.outputs.landing_stack_exists }}"
          fi

          if [[ "$DEPLOY_RESULT" == "success" ]] || [[ "$STACK_EXISTS" == "true" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "Running tests for $VERTICAL (deploy: $DEPLOY_RESULT, stack exists: $STACK_EXISTS)"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Skipping tests for $VERTICAL (deploy: $DEPLOY_RESULT, stack exists: $STACK_EXISTS)"
          fi

      - name: Checkout code
        if: steps.should_run.outputs.should_run == 'true'
        uses: actions/checkout@v4

      - name: Get URLs for ${{ matrix.vertical }}
        if: steps.should_run.outputs.should_run == 'true'
        id: urls
        run: |
          WEB_URL=""
          API_URL=""

          # Get URLs from deploy job outputs
          if [[ "${{ matrix.vertical }}" == "insurance" ]]; then
            WEB_URL="${{ needs.deploy-insurance-ui.outputs.web_url }}"
            API_URL="${{ needs.deploy-insurance-ui.outputs.api_url }}"
          elif [[ "${{ matrix.vertical }}" == "retail" ]]; then
            WEB_URL="${{ needs.deploy-retail-ui.outputs.web_url }}"
            API_URL="${{ needs.deploy-retail-ui.outputs.api_url }}"
          elif [[ "${{ matrix.vertical }}" == "landing" ]]; then
            WEB_URL="${{ needs.deploy-landing-ui.outputs.web_url }}"
          fi

          echo "web_url=${WEB_URL}" >> $GITHUB_OUTPUT
          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT

      - name: Run ${{ matrix.vertical }} ${{ matrix.category }} tests
        if: steps.should_run.outputs.should_run == 'true'
        uses: ./.github/actions/run-e2e-tests
        with:
          vertical: ${{ matrix.vertical }}
          category: ${{ matrix.category }}
          web-url: ${{ steps.urls.outputs.web_url }}
          api-url: ${{ steps.urls.outputs.api_url }}
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

  # ========================================
  # Demo Data Seeding
  # ========================================

  seed-insurance-data:
    name: Seed Insurance Data
    needs: [deploy-insurance-ui]
    if: needs.deploy-insurance-ui.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Seed insurance demo data
        uses: ./.github/actions/clear-and-seed-data
        with:
          api-base-url: ${{ needs.deploy-insurance-ui.outputs.api_url }}
          vertical: insurance

  seed-retail-data:
    name: Seed Retail Data
    needs: [deploy-retail-ui]
    if: needs.deploy-retail-ui.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Seed retail demo data
        uses: ./.github/actions/clear-and-seed-data
        with:
          api-base-url: ${{ needs.deploy-retail-ui.outputs.api_url }}
          vertical: retail

  # ========================================
  # Deployment Summary
  # ========================================

  deployment-summary:
    name: Deployment Summary
    needs: [
      deploy-insurance-ui,
      deploy-retail-ui,
      deploy-healthcare-ui,
      deploy-landing-ui,
      insurance-tests,
      retail-tests,
      e2e-healthcare,
      landing-tests,
      seed-insurance-data,
      seed-retail-data,
      seed-healthcare-data
    ]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Print deployment summary
        run: |
          echo "========================================="
          echo "Production Deployment Summary"
          echo "========================================="
          echo ""
          echo "üè• Insurance Vertical:"
          echo "  Infra: ${{ needs.deploy-insurance-ui.result }}"
          echo "  UI: ${{ needs.deploy-insurance-ui.result }}"
          echo "  API: ${{ needs.deploy-insurance-ui.outputs.api_url }}"
          echo "  Web: ${{ needs.deploy-insurance-ui.outputs.web_url }}"
          echo ""
          echo "üõí Retail Vertical:"
          echo "  Infra: ${{ needs.deploy-retail-ui.result }}"
          echo "  UI: ${{ needs.deploy-retail-ui.result }}"
          echo "  API: ${{ needs.deploy-retail-ui.outputs.api_url }}"
          echo "  Web: ${{ needs.deploy-retail-ui.outputs.web_url }}"
          echo ""
          echo "ü©∫ Healthcare Vertical:"
          echo "  Infra: ${{ needs.deploy-healthcare-ui.result }}"
          echo "  UI: ${{ needs.deploy-healthcare-ui.result }}"
          echo "  API: ${{ needs.deploy-healthcare-ui.outputs.api_url }}"
          echo "  Web: ${{ needs.deploy-healthcare-ui.outputs.web_url }}"
          echo ""
          echo "üè† Landing Page:"
          echo "  Infra: ${{ needs.deploy-landing-ui.result }}"
          echo "  UI: ${{ needs.deploy-landing-ui.result }}"
          echo "  Web: ${{ needs.deploy-landing-ui.outputs.web_url }}"
          echo ""
          echo "üß™ E2E Tests:"
          echo "  Insurance: ${{ needs.insurance-tests.result }}"
          echo "  Retail: ${{ needs.retail-tests.result }}"
          echo "  Healthcare: ${{ needs.e2e-healthcare.result }}"
          echo "  Landing: ${{ needs.landing-tests.result }}"
          echo ""
          echo "üå± Data Seeding:"
          echo "  Insurance: ${{ needs.seed-insurance-data.result }}"
          echo "  Retail: ${{ needs.seed-retail-data.result }}"
          echo "  Healthcare: ${{ needs.seed-healthcare-data.result }}"
          echo "========================================="
