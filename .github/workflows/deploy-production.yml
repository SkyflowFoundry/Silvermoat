name: Deploy Production Stack

on:
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to clean up test stack (optional)'
        required: false
        type: string
      skip_cleanup:
        description: 'Skip test stack cleanup'
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

jobs:
  cleanup-test:
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number != '' && github.event.inputs.skip_cleanup != 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup AWS CDK
        uses: ./.github/actions/setup-aws-cdk

      - name: Determine stack name
        id: stack-name
        run: |
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            PR_NUM="${{ github.event.pull_request.number }}"
          else
            PR_NUM="${{ github.event.inputs.pr_number }}"
          fi
          STACK_NAME="silvermoat-test-pr-${PR_NUM}"
          echo "stack_name=${STACK_NAME}" >> $GITHUB_OUTPUT
          echo "Cleaning up stack: ${STACK_NAME}"

      - name: Check if stack exists
        id: stack-check
        run: |
          if aws cloudformation describe-stacks --stack-name "${{ steps.stack-name.outputs.stack_name }}" 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Stack exists, will delete"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Stack does not exist, skipping deletion"
          fi

      - name: Delete stack
        if: steps.stack-check.outputs.exists == 'true'
        run: |
          echo "Deleting stack: ${{ steps.stack-name.outputs.stack_name }}"
          echo "Note: CDK destroy waits for deletion to complete automatically"
          chmod +x scripts/delete-stack.sh
          STACK_NAME="${{ steps.stack-name.outputs.stack_name }}" ./scripts/delete-stack.sh --yes

      - name: Cleanup summary
        if: always()
        run: |
          if [ "${{ steps.stack-check.outputs.exists }}" = "true" ]; then
            echo "‚úÖ Stack ${{ steps.stack-name.outputs.stack_name }} cleanup completed"
          else
            echo "‚ÑπÔ∏è No stack to clean up"
          fi

  detect-changes:
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      infrastructure_changed: ${{ steps.check.outputs.infrastructure_changed }}
      stack_exists: ${{ steps.check-stack.outputs.stack_exists }}

    steps:
      - name: Checkout merged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha || github.sha }}
          fetch-depth: 2

      - name: Detect infrastructure changes
        id: check
        run: |
          # For merged PRs, compare merge commit with its parent
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # Check files changed in the merge commit
            if git diff --name-only HEAD^ HEAD | grep -E '^(cdk/|lambda/|scripts/|\.github/workflows/deploy-production\.yml|\.github/actions/)'; then
              echo "infrastructure_changed=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Infrastructure files changed"
            else
              echo "infrastructure_changed=false" >> $GITHUB_OUTPUT
              echo "‚ÑπÔ∏è No infrastructure changes detected"
            fi
          else
            # Manual dispatch - deploy infrastructure
            echo "infrastructure_changed=true" >> $GITHUB_OUTPUT
            echo "Manual dispatch - will deploy infrastructure"
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Check if stack exists
        id: check-stack
        run: |
          if aws cloudformation describe-stacks --stack-name silvermoat >/dev/null 2>&1; then
            echo "stack_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Stack 'silvermoat' exists"
          else
            echo "stack_exists=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Stack 'silvermoat' does not exist"
          fi

  deploy-stack:
    needs: [detect-changes]
    if: |
      always() &&
      needs.detect-changes.result == 'success' &&
      (needs.detect-changes.outputs.infrastructure_changed == 'true' ||
       needs.detect-changes.outputs.stack_exists == 'false')
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install dependencies
        uses: ./.github/actions/install-deps
        with:
          install-ui: 'false'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup AWS CDK
        uses: ./.github/actions/setup-aws-cdk

      - name: Bootstrap CDK
        uses: ./.github/actions/bootstrap-cdk

      - name: Deploy production stack
        env:
          STACK_NAME: silvermoat
          APP_NAME: silvermoat
          STAGE_NAME: prod
          UI_SEEDING_MODE: external
          CREATE_CLOUDFRONT: true
          DOMAIN_NAME: silvermoat.net
        run: |
          echo "Deploying production stack: silvermoat"
          echo "Note: Clean deployment with full CloudFront + custom domain"
          chmod +x scripts/deploy-stack.sh
          ./scripts/deploy-stack.sh

  configure-dns:
    needs: [deploy-stack]
    if: always() && needs.deploy-stack.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup ACM validation (automatic)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          STACK_NAME: silvermoat
        run: |
          echo "Setting up ACM certificate DNS validation..."
          chmod +x scripts/setup-acm-validation.sh
          ./scripts/setup-acm-validation.sh || echo "‚ö†Ô∏è ACM validation setup failed or not needed"

      - name: Update Cloudflare DNS
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          STACK_NAME: silvermoat
          DOMAIN_NAME: silvermoat.net
        run: |
          echo "Running smart DNS update..."
          chmod +x scripts/update-cloudflare-dns.sh
          ./scripts/update-cloudflare-dns.sh

  deploy-ui:
    needs: [deploy-stack, configure-dns]
    if: |
      always() &&
      (needs.deploy-stack.result == 'success' || needs.deploy-stack.result == 'skipped') &&
      (needs.configure-dns.result == 'success' || needs.configure-dns.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      api_url: ${{ steps.stack-outputs.outputs.api_url }}
      web_url: ${{ steps.stack-outputs.outputs.web_url }}
      cloudfront_url: ${{ steps.stack-outputs.outputs.cloudfront_url }}
      cloudfront_id: ${{ steps.cloudfront.outputs.distribution_id }}
      ui_deployed: ${{ steps.check-ui.outputs.skip_ui != 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get CloudFront distribution ID
        id: cloudfront
        run: |
          # Extract distribution ID from UiDistribution resource
          DISTRIBUTION_ID=$(aws cloudformation describe-stack-resources \
            --stack-name silvermoat \
            --logical-resource-id UiDistribution \
            --query 'StackResources[0].PhysicalResourceId' \
            --output text 2>/dev/null || echo "")

          if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ]; then
            echo "distribution_id=${DISTRIBUTION_ID}" >> $GITHUB_OUTPUT
            echo "CloudFront Distribution ID: ${DISTRIBUTION_ID}"
          else
            echo "No CloudFront distribution found"
          fi

      - name: Check if UI needs deployment
        id: check-ui
        uses: ./.github/actions/check-ui-deployment
        with:
          stack-name: silvermoat

      - name: Build and deploy React UI
        if: steps.check-ui.outputs.skip_ui != 'true'
        env:
          STACK_NAME: silvermoat
        run: |
          echo "Building and deploying React UI..."
          chmod +x scripts/deploy-ui.sh
          ./scripts/deploy-ui.sh

      - name: Start CloudFront cache invalidation
        id: invalidation
        if: steps.cloudfront.outputs.distribution_id != '' && steps.check-ui.outputs.skip_ui != 'true'
        run: |
          echo "Starting CloudFront cache invalidation..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ steps.cloudfront.outputs.distribution_id }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          echo "invalidation_id=${INVALIDATION_ID}" >> $GITHUB_OUTPUT
          echo "Cache invalidation started: ${INVALIDATION_ID}"

      - name: Get stack outputs
        id: stack-outputs
        run: |
          # Get all outputs as JSON
          OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name silvermoat \
            --query 'Stacks[0].Outputs' \
            --output json)

          # Extract URLs
          API_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="ApiBaseUrl") | .OutputValue')
          CF_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="CloudFrontUrl") | .OutputValue')
          CUSTOM_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="CustomDomainUrl") | .OutputValue')

          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "cloudfront_url=${CF_URL}" >> $GITHUB_OUTPUT
          echo "web_url=${CUSTOM_URL:-$CF_URL}" >> $GITHUB_OUTPUT

          echo "API URL: ${API_URL}"
          echo "CloudFront URL: ${CF_URL}"
          echo "Custom Domain URL: ${CUSTOM_URL}"

      - name: Quick health check
        run: |
          API_URL="${{ steps.stack-outputs.outputs.api_url }}"
          echo "Running quick health check against ${API_URL}..."

          if curl -f -s "${API_URL}/" > /dev/null; then
            echo "‚úÖ API is responding"
          else
            echo "‚ùå API not responding, deployment may have failed"
            exit 1
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "==================================="
          echo "Production Deployment Summary"
          echo "==================================="
          echo "Stack: silvermoat"
          echo "UI deployment skipped: ${{ steps.check-ui.outputs.skip_ui }}"
          echo "API: ${{ steps.stack-outputs.outputs.api_url }}"
          echo "CloudFront: ${{ steps.stack-outputs.outputs.cloudfront_url }}"
          echo "Custom Domain: ${{ steps.stack-outputs.outputs.web_url }}"
          echo "==================================="
          if [ "${{ steps.check-ui.outputs.skip_ui }}" = "true" ]; then
            echo "‚ö° UI unchanged - saved ~2-3 minutes!"
          fi

  # Phase 1: Comprehensive Test Suite (Matrix Strategy)
  test-suite:
    needs: deploy-ui
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        test-type: [smoke, api, e2e]
        include:
          - test-type: smoke
            test-dir: smoke
            needs-chrome: false
          - test-type: api
            test-dir: api
            needs-chrome: false
          - test-type: e2e
            test-dir: e2e
            needs-chrome: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install Python dependencies
        run: pip install -r requirements-test.txt

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Install Chrome and ChromeDriver
        if: matrix.needs-chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Run ${{ matrix.test-type }} tests
        id: test-run
        continue-on-error: true
        env:
          STACK_NAME: silvermoat
          SILVERMOAT_API_URL: ${{ needs.deploy-ui.outputs.api_url }}
          SILVERMOAT_URL: ${{ needs.deploy-ui.outputs.web_url }}
          HEADLESS: '1'
        run: |
          set -o pipefail
          echo "Running ${{ matrix.test-type }} tests against production..."
          cd tests/${{ matrix.test-dir }}
          pytest -v --tb=short 2>&1 | tee ../../${{ matrix.test-type }}-tests-output.txt

      - name: Upload test output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.test-type }}-test-output
          path: ${{ matrix.test-type }}-tests-output.txt
          retention-days: 7

      - name: Check test outcome
        if: always()
        run: |
          if [ "${{ steps.test-run.outcome }}" = "failure" ]; then
            echo "${{ matrix.test-type }} tests failed"
            exit 1
          fi

  # Phase 4: Verify Deployment with Enhanced Reporting
  verify-deployment:
    needs: [deploy-ui, test-suite]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all test outputs
        uses: actions/download-artifact@v4
        with:
          path: test-outputs

      # Phase 3: Check CloudFront invalidation status
      - name: Check CloudFront invalidation status
        if: needs.deploy-ui.outputs.cloudfront_id != ''
        run: |
          # CloudFront invalidations are async and can take 10-15 minutes
          # We don't block on completion, just check status
          echo "CloudFront distribution: ${{ needs.deploy-ui.outputs.cloudfront_id }}"

          # Get latest invalidation status
          STATUS=$(aws cloudfront list-invalidations \
            --distribution-id ${{ needs.deploy-ui.outputs.cloudfront_id }} \
            --query 'InvalidationList.Items[0].Status' \
            --output text 2>/dev/null || echo "UNKNOWN")

          echo "Latest invalidation status: ${STATUS}"
          if [ "${STATUS}" = "Completed" ]; then
            echo "‚úÖ CloudFront cache invalidation complete"
          else
            echo "‚è≥ CloudFront cache invalidation in progress (${STATUS})"
            echo "Full propagation typically takes 10-15 minutes"
          fi

      # Phase 4: Aggregate test results
      - name: Aggregate test results
        id: aggregate
        run: |
          echo "Aggregating test results..."

          SMOKE_RESULT="${{ needs.test-suite.result }}"
          API_RESULT="${{ needs.test-suite.result }}"
          E2E_RESULT="${{ needs.test-suite.result }}"

          # Count test results
          TOTAL_TESTS=0
          PASSED_TESTS=0

          for output in test-outputs/*/; do
            if [ -d "$output" ]; then
              TEST_TYPE=$(basename "$output" | sed 's/-test-output//')
              OUTPUT_FILE="${output}${TEST_TYPE}-tests-output.txt"

              if [ -f "$OUTPUT_FILE" ]; then
                PASSED=$(grep -o "[0-9]* passed" "$OUTPUT_FILE" | head -1 | awk '{print $1}' || echo "0")
                FAILED=$(grep -o "[0-9]* failed" "$OUTPUT_FILE" | head -1 | awk '{print $1}' || echo "0")

                TOTAL=$((PASSED + FAILED))
                TOTAL_TESTS=$((TOTAL_TESTS + TOTAL))
                PASSED_TESTS=$((PASSED_TESTS + PASSED))

                echo "${TEST_TYPE}: ${PASSED}/${TOTAL} passed"
              fi
            fi
          done

          echo "total_tests=${TOTAL_TESTS}" >> $GITHUB_OUTPUT
          echo "passed_tests=${PASSED_TESTS}" >> $GITHUB_OUTPUT

          PASS_RATE=$((PASSED_TESTS * 100 / TOTAL_TESTS))
          echo "pass_rate=${PASS_RATE}" >> $GITHUB_OUTPUT

      # Phase 4: Generate deployment report
      - name: Generate deployment report
        run: |
          cat > deployment-report.md << EOF
          # üöÄ Production Deployment Report

          **Deployed:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Commit:** ${{ github.sha }}
          **Triggered by:** ${{ github.actor }}

          ## Deployment Status

          - **Stack:** silvermoat
          - **UI Deployed:** ${{ needs.deploy-ui.outputs.ui_deployed }}
          - **API URL:** ${{ needs.deploy-ui.outputs.api_url }}
          - **Web URL:** ${{ needs.deploy-ui.outputs.web_url }}

          ## Test Results

          **Overall:** ${{ steps.aggregate.outputs.passed_tests }}/${{ steps.aggregate.outputs.total_tests }} tests passed (${{ steps.aggregate.outputs.pass_rate }}%)

          - **Smoke Tests:** ${{ needs.test-suite.result }}
          - **API Tests:** ${{ needs.test-suite.result }}
          - **E2E Tests:** ${{ needs.test-suite.result }}

          ## Optimization Savings

          EOF

          if [ "${{ needs.deploy-ui.outputs.ui_deployed }}" = "false" ]; then
            echo "‚ö° **UI unchanged** - Saved ~2-3 minutes" >> deployment-report.md
          fi

          cat deployment-report.md

      - name: Upload deployment report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.md
          retention-days: 30

      # Final pass/fail check
      - name: Check deployment status
        if: always()
        run: |
          if [ "${{ needs.test-suite.result }}" = "failure" ]; then
            echo "‚ùå One or more test suites failed"
            exit 1
          fi

          if [ "${{ needs.deploy-ui.result }}" = "failure" ]; then
            echo "‚ùå Deployment failed"
            exit 1
          fi

          echo "‚úÖ Production deployment successful with all tests passing"
