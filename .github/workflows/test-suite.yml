name: Tests

on:
  workflow_call:
    inputs:
      stack_name:
        description: 'Stack name for test environment'
        required: true
        type: string
      api_url:
        description: 'API base URL'
        required: true
        type: string
      web_url:
        description: 'Web application URL'
        required: true
        type: string
      environment:
        description: 'Environment name (test/production)'
        required: false
        type: string
        default: 'test'
    secrets:
      AWS_ROLE_ARN:
        description: 'AWS role ARN for authentication'
        required: true

jobs:
  lambda-unit-tests:
    name: Lambda Unit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: lambda-handlers
            pattern: "test_*_handler.py"
            python-version: '3.11'
          - name: lambda-handlers
            pattern: "test_*_handler.py"
            python-version: '3.12'
          - name: lambda-utilities
            pattern: "test_responses.py test_validators.py test_events.py test_domain_logic.py test_storage_dynamodb.py"
            python-version: '3.11'
          - name: lambda-utilities
            pattern: "test_responses.py test_validators.py test_events.py test_domain_logic.py test_storage_dynamodb.py"
            python-version: '3.12'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: requirements-test.txt

      - name: Install Python dependencies
        run: pip install -r requirements-test.txt

      - name: Run ${{ matrix.name }} tests (Python ${{ matrix.python-version }})
        id: test-run
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}/lambda/layer/python:${{ github.workspace }}/lambda:${{ github.workspace }}/lambda/ai_handler:${{ github.workspace }}/lambda/customer_handler:${{ github.workspace }}/lambda/claims_handler:${{ github.workspace }}/lambda/documents_handler
          AWS_DEFAULT_REGION: us-east-1
          AWS_ACCESS_KEY_ID: testing
          AWS_SECRET_ACCESS_KEY: testing
          CUSTOMERS_TABLE: test-customers
          QUOTES_TABLE: test-quotes
          POLICIES_TABLE: test-policies
          CLAIMS_TABLE: test-claims
          PAYMENTS_TABLE: test-payments
          CASES_TABLE: test-cases
          DOCS_BUCKET: test-docs
          SNS_TOPIC_ARN: ""
        run: |
          set -o pipefail
          cd lambda/tests
          pytest -v --tb=short ${{ matrix.pattern }} 2>&1 | tee ../../${{ matrix.name }}-python${{ matrix.python-version }}-tests-output.txt

      - name: Upload test output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-python${{ matrix.python-version }}-test-output
          path: ${{ matrix.name }}-python${{ matrix.python-version }}-tests-output.txt
          retention-days: 7

      - name: Check test outcome
        if: always()
        run: |
          if [ "${{ steps.test-run.outcome }}" = "failure" ]; then
            echo "${{ matrix.name }} tests failed on Python ${{ matrix.python-version }}"
            exit 1
          fi

  unit-tests:
    name: UI Unit
    runs-on: ubuntu-latest
    timeout-minutes: 5

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: unit-utils
            pattern: "src/utils/**/*.test.{js,jsx,ts,tsx}"
          - name: unit-components
            pattern: "src/components/**/*.test.{js,jsx,ts,tsx}"
          - name: unit-hooks
            pattern: "src/hooks/**/*.test.{js,jsx,ts,tsx}"
          - name: unit-contexts
            pattern: "src/contexts/**/*.test.{js,jsx,ts,tsx}"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install UI dependencies
        run: |
          cd ui
          npm ci --silent

      - name: Run ${{ matrix.name }} tests
        id: test-run
        continue-on-error: true
        run: |
          set -o pipefail
          cd ui
          # Run tests matching the pattern, exit 0 if no tests found
          npm test -- --run "${{ matrix.pattern }}" 2>&1 | tee ../${{ matrix.name }}-tests-output.txt || {
            if grep -q "No test files found" ../${{ matrix.name }}-tests-output.txt; then
              echo "No tests found for ${{ matrix.pattern }}, skipping..."
              echo "SKIPPED=true" >> $GITHUB_OUTPUT
              exit 0
            else
              exit 1
            fi
          }

      - name: Upload test output
        if: always() && steps.test-run.outputs.SKIPPED != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-test-output
          path: ${{ matrix.name }}-tests-output.txt
          retention-days: 7

      - name: Check test outcome
        if: always() && steps.test-run.outputs.SKIPPED != 'true'
        run: |
          if [ "${{ steps.test-run.outcome }}" = "failure" ]; then
            echo "${{ matrix.name }} tests failed"
            exit 1
          fi

  api-tests:
    name: API
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: api-smoke
            file: ""
            args: ""
          - name: api-cases
            file: test_cases.py
            args: ""
          - name: api-security
            file: test_security.py
            args: ""
          - name: api-chatbot
            file: test_chatbot.py
            args: ""
          - name: api-customer-chatbot
            file: test_customer_chatbot.py
            args: ""
          - name: api-customers
            file: test_customers.py
            args: ""
          - name: api-payments
            file: test_payments.py
            args: ""
          - name: api-policies
            file: test_policies.py
            args: ""
          - name: api-quotes
            file: test_quotes.py
            args: ""
          - name: api-claims
            file: test_claims.py
            args: ""
          - name: api-root
            file: test_root.py
            args: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install Python dependencies
        run: pip install -r requirements-test.txt

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Run ${{ matrix.name }} tests
        id: test-run
        continue-on-error: true
        env:
          STACK_NAME: ${{ inputs.stack_name }}
          SILVERMOAT_API_URL: ${{ inputs.api_url }}
          SILVERMOAT_URL: ${{ inputs.web_url }}
        run: |
          set -o pipefail
          echo "Running ${{ matrix.name }} tests against ${{ inputs.environment }}..."
          cd tests/api
          pytest -v --tb=short ${{ matrix.file }} ${{ matrix.args }} 2>&1 | tee ../../${{ matrix.name }}-tests-output.txt

      - name: Upload test output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-test-output
          path: ${{ matrix.name }}-tests-output.txt
          retention-days: 7

      - name: Upload test artifacts (screenshots, page source, logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-test-artifacts
          path: tests/api/test-artifacts/
          retention-days: 7
          if-no-files-found: ignore

      - name: Check test outcome
        if: always()
        run: |
          if [ "${{ steps.test-run.outcome }}" = "failure" ]; then
            echo "${{ matrix.name }} tests failed"
            exit 1
          fi

  e2e-tests:
    name: E2E
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: e2e-smoke-deployment
            dir: smoke
            args: ""
            needs-chrome: false
          - name: e2e-smoke-landing
            dir: e2e
            args: "-m smoke"
            needs-chrome: true
          - name: e2e-forms
            dir: e2e
            args: "-m forms"
            needs-chrome: true
          - name: e2e-customer
            dir: e2e
            args: "-m customer"
            needs-chrome: true
          - name: e2e-navigation
            dir: e2e
            args: "tests/test_landing_page.py -m 'e2e and not smoke'"
            needs-chrome: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install Python dependencies
        run: pip install -r requirements-test.txt

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Install Chrome and ChromeDriver
        if: matrix.needs-chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
          install-chromedriver: true

      - name: Cache ChromeDriver
        if: matrix.needs-chrome
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/chromedriver
          key: ${{ runner.os }}-chromedriver-${{ hashFiles('**/requirements-test.txt') }}
          restore-keys: |
            ${{ runner.os }}-chromedriver-

      - name: Run ${{ matrix.name }} tests
        id: test-run
        continue-on-error: true
        env:
          STACK_NAME: ${{ inputs.stack_name }}
          SILVERMOAT_API_URL: ${{ inputs.api_url }}
          SILVERMOAT_URL: ${{ inputs.web_url }}
          HEADLESS: '1'
        run: |
          set -o pipefail
          echo "Running ${{ matrix.name }} tests against ${{ inputs.environment }}..."
          cd tests/${{ matrix.dir }}
          pytest -v --tb=short ${{ matrix.args }} 2>&1 | tee ../../${{ matrix.name }}-tests-output.txt

      - name: Upload test output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-test-output
          path: ${{ matrix.name }}-tests-output.txt
          retention-days: 7

      - name: Upload test artifacts (screenshots, page source, logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-test-artifacts
          path: tests/${{ matrix.dir }}/test-artifacts/
          retention-days: 7
          if-no-files-found: ignore

      - name: Check test outcome
        if: always()
        run: |
          if [ "${{ steps.test-run.outcome }}" = "failure" ]; then
            echo "${{ matrix.name }} tests failed"
            exit 1
          fi
