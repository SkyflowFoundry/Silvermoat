name: Deploy Test Stack (Parallel)

on:
  pull_request:
    branches: [main]
    paths:
      - 'cdk/**'
      - 'lambda/**'
      - 'ui-insurance/**'
      - 'ui-retail/**'
      - 'ui-shared/**'
      - 'tests/**'
      - 'scripts/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number for stack naming (optional)'
        required: false
      force_deploy:
        description: 'Force stack deployment even if no changes detected'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  detect-changes:
    name: Detect Changed Files
    runs-on: ubuntu-latest
    outputs:
      infrastructure_changed: ${{ steps.filter.outputs.infrastructure }}
      ui_changed: ${{ steps.filter.outputs.ui }}
      tests_changed: ${{ steps.filter.outputs.tests }}
      base_stack_name: ${{ steps.stack-name.outputs.base_stack_name }}
    steps:
      - name: Post workflow start comment
        if: github.event.pull_request.number
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ðŸš€ **Test deployment started** (Parallel Multi-Vertical)\n\n[View workflow run â†’](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            });

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            infrastructure:
              - 'cdk/**'
              - 'lambda/**'
              - 'scripts/deploy-stack.sh'
            ui:
              - 'ui-insurance/**'
              - 'ui-retail/**'
              - 'ui-shared/**'
              - 'scripts/generate-architecture-diagram.py'
              - 'scripts/deploy-ui.sh'
            tests:
              - 'tests/**'
              - '.github/workflows/**'

      - name: Determine base stack name
        id: stack-name
        run: |
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            BASE_STACK_NAME="silvermoat-test-pr-${{ github.event.pull_request.number }}"
          elif [ -n "${{ inputs.pr_number }}" ]; then
            BASE_STACK_NAME="silvermoat-test-pr-${{ inputs.pr_number }}"
          else
            BASE_STACK_NAME="silvermoat-test-${{ github.run_id }}"
          fi
          echo "base_stack_name=${BASE_STACK_NAME}" >> $GITHUB_OUTPUT
          echo "Base stack name: ${BASE_STACK_NAME}"

  # ========================================
  # Insurance Vertical Pipeline
  # ========================================

  deploy-insurance-infra:
    name: Deploy Insurance Infra
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.infrastructure_changed == 'true' ||
      inputs.force_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      stack_name: ${{ steps.deploy.outputs.stack_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements-test.txt

      - name: Install dependencies
        uses: ./.github/actions/install-deps
        with:
          install-ui: 'false'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup AWS CDK
        uses: ./.github/actions/setup-aws-cdk

      - name: Bootstrap CDK
        uses: ./.github/actions/bootstrap-cdk

      - name: Deploy insurance stack
        id: deploy
        env:
          STACK_NAME: ${{ needs.detect-changes.outputs.base_stack_name }}
          VERTICAL: insurance
        run: |
          echo "Deploying insurance stack: ${STACK_NAME}-insurance"
          chmod +x scripts/deploy-stack.sh
          ./scripts/deploy-stack.sh
          echo "stack_name=${STACK_NAME}-insurance" >> $GITHUB_OUTPUT

  deploy-insurance-ui:
    name: Deploy Insurance UI
    needs: [detect-changes, deploy-insurance-infra]
    if: |
      always() &&
      (needs.deploy-insurance-infra.result == 'success' || needs.deploy-insurance-infra.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      api_url: ${{ steps.outputs.outputs.api_url }}
      web_url: ${{ steps.outputs.outputs.web_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Build and deploy insurance UI
        env:
          STACK_NAME: ${{ needs.detect-changes.outputs.base_stack_name }}
          VERTICAL: insurance
        run: |
          chmod +x scripts/deploy-ui.sh
          ./scripts/deploy-ui.sh

      - name: Get stack outputs
        id: outputs
        run: |
          STACK_NAME="${{ needs.detect-changes.outputs.base_stack_name }}-insurance"

          OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_NAME}" \
            --query 'Stacks[0].Outputs' \
            --output json)

          API_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="InsuranceApiUrl") | .OutputValue')
          WEB_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="InsuranceUiBucketWebsiteURL") | .OutputValue')

          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "web_url=${WEB_URL}" >> $GITHUB_OUTPUT

  insurance-tests:
    name: Insurance Tests
    needs: [deploy-insurance-infra, deploy-insurance-ui]
    if: always() && (needs.deploy-insurance-infra.result == 'success' || needs.deploy-insurance-ui.result == 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        test-type: ['lambda', 'ui', 'api', 'e2e']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Lambda tests
      - name: Set up Python for lambda tests
        if: matrix.test-type == 'lambda'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements-test.txt

      - name: Install Python dependencies for lambda tests
        if: matrix.test-type == 'lambda'
        run: pip install -r requirements-test.txt

      - name: Run lambda tests
        if: matrix.test-type == 'lambda'
        env:
          PYTHONPATH: ${{ github.workspace }}/lambda/layer/python:${{ github.workspace }}/lambda
        run: |
          cd lambda/tests
          pytest -v --tb=short

      # UI tests
      - name: Setup environment for UI tests
        if: matrix.test-type == 'ui'
        uses: ./.github/actions/setup-env

      - name: Install UI dependencies
        if: matrix.test-type == 'ui'
        working-directory: ui-insurance
        run: npm ci

      - name: Run UI unit tests
        if: matrix.test-type == 'ui'
        working-directory: ui-insurance
        run: npm test

      # API tests
      - name: Set up Python for API tests
        if: matrix.test-type == 'api'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements-test.txt

      - name: Install Python dependencies for API tests
        if: matrix.test-type == 'api'
        run: pip install -r requirements-test.txt

      - name: Run insurance API tests
        if: matrix.test-type == 'api'
        env:
          API_BASE_URL: ${{ needs.deploy-insurance-ui.outputs.api_url }}
        run: |
          cd tests/api
          pytest -v --tb=short -m "not retail"

      # E2E tests
      - name: Setup environment for E2E tests
        if: matrix.test-type == 'e2e'
        uses: ./.github/actions/setup-env

      - name: Install Python dependencies for E2E tests
        if: matrix.test-type == 'e2e'
        run: pip install -r requirements-test.txt

      - name: Configure AWS credentials for E2E tests
        if: matrix.test-type == 'e2e'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Install Chrome and ChromeDriver
        if: matrix.test-type == 'e2e'
        uses: browser-actions/setup-chrome@v1

      - name: Run insurance E2E tests
        if: matrix.test-type == 'e2e'
        env:
          WEB_BASE_URL: ${{ needs.deploy-insurance-ui.outputs.web_url }}
          API_BASE_URL: ${{ needs.deploy-insurance-ui.outputs.api_url }}
        run: |
          cd tests/e2e
          pytest -v --tb=short -m "e2e and not retail"

  seed-insurance-data:
    name: Seed Insurance Data
    needs: [deploy-insurance-ui, insurance-tests]
    if: |
      always() &&
      needs.deploy-insurance-ui.result == 'success' &&
      contains(needs.insurance-tests.result, 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Seed insurance demo data
        uses: ./.github/actions/clear-and-seed-data
        with:
          api-base-url: ${{ needs.deploy-insurance-ui.outputs.api_url }}
          vertical: insurance

  # ========================================
  # Retail Vertical Pipeline
  # ========================================

  deploy-retail-infra:
    name: Deploy Retail Infra
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.infrastructure_changed == 'true' ||
      inputs.force_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      stack_name: ${{ steps.deploy.outputs.stack_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements-test.txt

      - name: Install dependencies
        uses: ./.github/actions/install-deps
        with:
          install-ui: 'false'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup AWS CDK
        uses: ./.github/actions/setup-aws-cdk

      - name: Bootstrap CDK
        uses: ./.github/actions/bootstrap-cdk

      - name: Deploy retail stack
        id: deploy
        env:
          STACK_NAME: ${{ needs.detect-changes.outputs.base_stack_name }}
          VERTICAL: retail
        run: |
          echo "Deploying retail stack: ${STACK_NAME}-retail"
          chmod +x scripts/deploy-stack.sh
          ./scripts/deploy-stack.sh
          echo "stack_name=${STACK_NAME}-retail" >> $GITHUB_OUTPUT

  deploy-retail-ui:
    name: Deploy Retail UI
    needs: [detect-changes, deploy-retail-infra]
    if: |
      always() &&
      (needs.deploy-retail-infra.result == 'success' || needs.deploy-retail-infra.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      api_url: ${{ steps.outputs.outputs.api_url }}
      web_url: ${{ steps.outputs.outputs.web_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Build and deploy retail UI
        env:
          STACK_NAME: ${{ needs.detect-changes.outputs.base_stack_name }}
          VERTICAL: retail
        run: |
          chmod +x scripts/deploy-ui.sh
          ./scripts/deploy-ui.sh

      - name: Get stack outputs
        id: outputs
        run: |
          STACK_NAME="${{ needs.detect-changes.outputs.base_stack_name }}-retail"

          OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_NAME}" \
            --query 'Stacks[0].Outputs' \
            --output json)

          API_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="RetailApiUrl") | .OutputValue')
          WEB_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="RetailUiBucketWebsiteURL") | .OutputValue')

          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "web_url=${WEB_URL}" >> $GITHUB_OUTPUT

  retail-tests:
    name: Retail Tests
    needs: [deploy-retail-infra, deploy-retail-ui]
    if: always() && (needs.deploy-retail-infra.result == 'success' || needs.deploy-retail-ui.result == 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        test-type: ['lambda', 'ui', 'api', 'e2e']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Lambda tests
      - name: Set up Python for lambda tests
        if: matrix.test-type == 'lambda'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements-test.txt

      - name: Install Python dependencies for lambda tests
        if: matrix.test-type == 'lambda'
        run: pip install -r requirements-test.txt

      - name: Run lambda tests
        if: matrix.test-type == 'lambda'
        env:
          PYTHONPATH: ${{ github.workspace }}/lambda/layer/python:${{ github.workspace }}/lambda
        run: |
          cd lambda/tests
          pytest -v --tb=short

      # UI tests
      - name: Setup environment for UI tests
        if: matrix.test-type == 'ui'
        uses: ./.github/actions/setup-env

      - name: Install UI dependencies
        if: matrix.test-type == 'ui'
        working-directory: ui-retail
        run: npm ci

      - name: Run UI unit tests
        if: matrix.test-type == 'ui'
        working-directory: ui-retail
        run: npm test

      # API tests
      - name: Set up Python for API tests
        if: matrix.test-type == 'api'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements-test.txt

      - name: Install Python dependencies for API tests
        if: matrix.test-type == 'api'
        run: pip install -r requirements-test.txt

      - name: Run retail API tests
        if: matrix.test-type == 'api'
        env:
          API_BASE_URL: ${{ needs.deploy-retail-ui.outputs.api_url }}
        run: |
          cd tests/api
          pytest -v --tb=short -m "retail"

      # E2E tests
      - name: Setup environment for E2E tests
        if: matrix.test-type == 'e2e'
        uses: ./.github/actions/setup-env

      - name: Install Python dependencies for E2E tests
        if: matrix.test-type == 'e2e'
        run: pip install -r requirements-test.txt

      - name: Configure AWS credentials for E2E tests
        if: matrix.test-type == 'e2e'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Install Chrome and ChromeDriver
        if: matrix.test-type == 'e2e'
        uses: browser-actions/setup-chrome@v1

      - name: Run retail E2E tests
        if: matrix.test-type == 'e2e'
        env:
          WEB_BASE_URL: ${{ needs.deploy-retail-ui.outputs.web_url }}
          API_BASE_URL: ${{ needs.deploy-retail-ui.outputs.api_url }}
        run: |
          cd tests/e2e
          pytest -v --tb=short -m "retail"

  seed-retail-data:
    name: Seed Retail Data
    needs: [deploy-retail-ui, retail-tests]
    if: |
      always() &&
      needs.deploy-retail-ui.result == 'success' &&
      contains(needs.retail-tests.result, 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Seed retail demo data
        uses: ./.github/actions/clear-and-seed-data
        with:
          api-base-url: ${{ needs.deploy-retail-ui.outputs.api_url }}
          vertical: retail

  # ========================================
  # Post-Deployment Summary
  # ========================================

  pr-summary:
    name: Post PR Summary
    needs: [
      detect-changes,
      deploy-insurance-infra,
      deploy-insurance-ui,
      insurance-tests,
      seed-insurance-data,
      deploy-retail-infra,
      deploy-retail-ui,
      retail-tests,
      seed-retail-data
    ]
    if: always() && github.event.pull_request.number
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build PR summary comment
        id: summary
        run: |
          cat > /tmp/pr-comment.md <<'EOF'
          ## ðŸš€ Multi-Vertical Test Deployment Summary

          **PR**: #${{ github.event.pull_request.number }}
          **Workflow Run**: [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          EOF

          # Add deployment status table
          cat >> /tmp/pr-comment.md <<EOF
          ### Deployment Status

          | Vertical | Infrastructure | UI | Tests | Data Seeding |
          |----------|---------------|-----|-------|--------------|
          | ðŸ¥ **Insurance** | ${{ needs.deploy-insurance-infra.result == 'success' && 'âœ…' || needs.deploy-insurance-infra.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.deploy-insurance-ui.result == 'success' && 'âœ…' || needs.deploy-insurance-ui.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.insurance-tests.result == 'success' && 'âœ…' || needs.insurance-tests.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.seed-insurance-data.result == 'success' && 'âœ…' || needs.seed-insurance-data.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          | ðŸ›’ **Retail** | ${{ needs.deploy-retail-infra.result == 'success' && 'âœ…' || needs.deploy-retail-infra.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.deploy-retail-ui.result == 'success' && 'âœ…' || needs.deploy-retail-ui.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.retail-tests.result == 'success' && 'âœ…' || needs.retail-tests.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.seed-retail-data.result == 'success' && 'âœ…' || needs.seed-retail-data.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |

          EOF

          # Add environment URLs if successful
          INSURANCE_UI_SUCCESS="${{ needs.deploy-insurance-ui.result == 'success' }}"
          RETAIL_UI_SUCCESS="${{ needs.deploy-retail-ui.result == 'success' }}"
          INSURANCE_SEED_SUCCESS="${{ needs.seed-insurance-data.result == 'success' }}"
          RETAIL_SEED_SUCCESS="${{ needs.seed-retail-data.result == 'success' }}"

          if [ "$INSURANCE_UI_SUCCESS" = "true" ] || [ "$RETAIL_UI_SUCCESS" = "true" ]; then
            cat >> /tmp/pr-comment.md <<EOF
          ---

          ### ðŸŒ Test Environments

          EOF

            if [ "$INSURANCE_UI_SUCCESS" = "true" ]; then
              INSURANCE_STATUS=""
              if [ "$INSURANCE_SEED_SUCCESS" = "true" ]; then
                INSURANCE_STATUS=" âœ… Ready with demo data"
              else
                INSURANCE_STATUS=" âš ï¸ Deployed (demo data pending)"
              fi
              cat >> /tmp/pr-comment.md <<EOF
          #### ðŸ¥ Insurance Vertical${INSURANCE_STATUS}
          **Web URL:** ${{ needs.deploy-insurance-ui.outputs.web_url }}
          **API URL:** ${{ needs.deploy-insurance-ui.outputs.api_url }}

          EOF
            fi

            if [ "$RETAIL_UI_SUCCESS" = "true" ]; then
              RETAIL_STATUS=""
              if [ "$RETAIL_SEED_SUCCESS" = "true" ]; then
                RETAIL_STATUS=" âœ… Ready with demo data"
              else
                RETAIL_STATUS=" âš ï¸ Deployed (demo data pending)"
              fi
              cat >> /tmp/pr-comment.md <<EOF
          #### ðŸ›’ Retail Vertical${RETAIL_STATUS}
          **Web URL:** ${{ needs.deploy-retail-ui.outputs.web_url }}
          **API URL:** ${{ needs.deploy-retail-ui.outputs.api_url }}

          EOF
            fi
          fi

          # Add failure notice if any failures
          if [ "${{ needs.deploy-insurance-infra.result }}" = "failure" ] || \
             [ "${{ needs.deploy-insurance-ui.result }}" = "failure" ] || \
             [ "${{ needs.insurance-tests.result }}" = "failure" ] || \
             [ "${{ needs.deploy-retail-infra.result }}" = "failure" ] || \
             [ "${{ needs.deploy-retail-ui.result }}" = "failure" ] || \
             [ "${{ needs.retail-tests.result }}" = "failure" ]; then
            cat >> /tmp/pr-comment.md <<EOF
          ---

          âš ï¸ **Some deployments or tests failed.** Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
          EOF
          fi

          echo "comment_file=/tmp/pr-comment.md" >> $GITHUB_OUTPUT

      - name: Post comment to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const commentBody = fs.readFileSync('/tmp/pr-comment.md', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
