name: Deploy Test Stack (Parallel)

on:
  pull_request:
    branches: [main]
    paths:
      - 'cdk/**'
      - 'lambda/**'
      - 'ui-insurance/**'
      - 'ui-retail/**'
      - 'ui-healthcare/**'
      - 'ui-fintech/**'
      - 'tests/e2e/**'
      - 'scripts/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number for stack naming (optional)'
        required: false
      force_deploy:
        description: 'Force stack deployment even if no changes detected'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  detect-changes:
    name: Detect Changed Files
    runs-on: ubuntu-latest
    outputs:
      infrastructure_changed: ${{ steps.filter.outputs.infrastructure }}
      ui_changed: ${{ steps.filter.outputs.ui }}
      tests_changed: ${{ steps.filter.outputs.tests }}
      base_stack_name: ${{ steps.stack-name.outputs.base_stack_name }}
      insurance_stack_exists: ${{ steps.check-stacks.outputs.insurance_exists }}
      retail_stack_exists: ${{ steps.check-stacks.outputs.retail_exists }}
      healthcare_stack_exists: ${{ steps.check-stacks.outputs.healthcare_exists }}
      fintech_stack_exists: ${{ steps.check-stacks.outputs.fintech_exists }}
      landing_stack_exists: ${{ steps.check-stacks.outputs.landing_exists }}
    steps:
      - name: Post workflow start comment
        if: github.event.pull_request.number
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ðŸš€ **Test deployment started** (Parallel Multi-Vertical)\n\n[View workflow run â†’](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            });

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        id: filter
        uses: ./.github/actions/detect-changes

      - name: Determine base stack name
        id: stack-name
        run: |
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            BASE_STACK_NAME="silvermoat-test-pr-${{ github.event.pull_request.number }}"
          elif [ -n "${{ inputs.pr_number }}" ]; then
            BASE_STACK_NAME="silvermoat-test-pr-${{ inputs.pr_number }}"
          else
            BASE_STACK_NAME="silvermoat-test-${{ github.run_id }}"
          fi
          echo "base_stack_name=${BASE_STACK_NAME}" >> $GITHUB_OUTPUT
          echo "Base stack name: ${BASE_STACK_NAME}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Check if stacks exist
        id: check-stacks
        run: |
          BASE_STACK_NAME="${{ steps.stack-name.outputs.base_stack_name }}"

          # Check insurance stack
          if aws cloudformation describe-stacks --stack-name "${BASE_STACK_NAME}-insurance" >/dev/null 2>&1; then
            echo "insurance_exists=true" >> $GITHUB_OUTPUT
            echo "Insurance stack exists: ${BASE_STACK_NAME}-insurance"
          else
            echo "insurance_exists=false" >> $GITHUB_OUTPUT
            echo "Insurance stack does not exist: ${BASE_STACK_NAME}-insurance"
          fi

          # Check retail stack
          if aws cloudformation describe-stacks --stack-name "${BASE_STACK_NAME}-retail" >/dev/null 2>&1; then
            echo "retail_exists=true" >> $GITHUB_OUTPUT
            echo "Retail stack exists: ${BASE_STACK_NAME}-retail"
          else
            echo "retail_exists=false" >> $GITHUB_OUTPUT
            echo "Retail stack does not exist: ${BASE_STACK_NAME}-retail"
          fi

          # Check healthcare stack
          if aws cloudformation describe-stacks --stack-name "${BASE_STACK_NAME}-healthcare" >/dev/null 2>&1; then
            echo "healthcare_exists=true" >> $GITHUB_OUTPUT
            echo "Healthcare stack exists: ${BASE_STACK_NAME}-healthcare"
          else
            echo "healthcare_exists=false" >> $GITHUB_OUTPUT
            echo "Healthcare stack does not exist: ${BASE_STACK_NAME}-healthcare"
          fi

          # Check fintech stack
          if aws cloudformation describe-stacks --stack-name "${BASE_STACK_NAME}-fintech" >/dev/null 2>&1; then
            echo "fintech_exists=true" >> $GITHUB_OUTPUT
            echo "Fintech stack exists: ${BASE_STACK_NAME}-fintech"
          else
            echo "fintech_exists=false" >> $GITHUB_OUTPUT
            echo "Fintech stack does not exist: ${BASE_STACK_NAME}-fintech"
          fi

          # Check landing stack
          if aws cloudformation describe-stacks --stack-name "${BASE_STACK_NAME}-landing" >/dev/null 2>&1; then
            echo "landing_exists=true" >> $GITHUB_OUTPUT
            echo "Landing stack exists: ${BASE_STACK_NAME}-landing"
          else
            echo "landing_exists=false" >> $GITHUB_OUTPUT
            echo "Landing stack does not exist: ${BASE_STACK_NAME}-landing"
          fi

  # ========================================
  # Insurance Vertical Pipeline
  # ========================================

  deploy-landing-infra:
    name: Deploy Landing Infra
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.infrastructure_changed == 'true' ||
      needs.detect-changes.outputs.landing_lambda_changed == 'true' ||
      needs.detect-changes.outputs.landing_stack_exists == 'false' ||
      inputs.force_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      stack_name: ${{ steps.deploy.outputs.stack_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup infrastructure deployment
        uses: ./.github/actions/setup-infra-deploy
        with:
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

      - name: Deploy landing stack
        id: deploy
        env:
          STACK_NAME: ${{ needs.detect-changes.outputs.base_stack_name }}
          VERTICAL: landing
          STAGE_NAME: test-${{ github.run_id }}
        run: |
          echo "Deploying landing stack: ${STACK_NAME}-landing"
          chmod +x scripts/deploy-stack.sh
          ./scripts/deploy-stack.sh
          echo "stack_name=${STACK_NAME}-landing" >> $GITHUB_OUTPUT

  deploy-landing-ui:
    name: Deploy Landing UI
    needs: [detect-changes, deploy-landing-infra, deploy-insurance-infra, deploy-retail-infra, deploy-healthcare-infra, deploy-fintech-infra]
    if: |
      always() &&
      (needs.detect-changes.outputs.ui_changed == 'true' || needs.detect-changes.outputs.landing_ui_changed == 'true' || needs.deploy-landing-infra.result == 'success' || inputs.force_deploy == 'true') &&
      (needs.deploy-landing-infra.result == 'success' || needs.deploy-landing-infra.result == 'skipped') &&
      (needs.deploy-insurance-ui.result == 'success' || needs.deploy-insurance-ui.result == 'skipped') &&
      (needs.deploy-retail-ui.result == 'success' || needs.deploy-retail-ui.result == 'skipped') &&
      (needs.deploy-fintech-ui.result == 'success' || needs.deploy-fintech-ui.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      web_url: ${{ steps.deploy.outputs.web_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-env

      - name: Install Graphviz for diagram generation
        run: sudo apt-get update && sudo apt-get install -y graphviz

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Deploy Landing UI
        env:
          VERTICAL: landing
          STACK_NAME: ${{ needs.detect-changes.outputs.base_stack_name }}
        run: ./scripts/deploy-ui.sh

      - name: Set output
        id: deploy
        run: |
          WEB_URL=$(aws cloudformation describe-stacks \
            --stack-name "${{ needs.detect-changes.outputs.base_stack_name }}-landing" \
            --query 'Stacks[0].Outputs[?OutputKey==`LandingUiBucketWebsiteURL`].OutputValue' \
            --output text 2>/dev/null || echo "")
          echo "web_url=${WEB_URL}" >> $GITHUB_OUTPUT

  landing-tests:
    name: Landing E2E Tests
    needs: [detect-changes, deploy-landing-infra, deploy-landing-ui]
    if: |
      always() &&
      (needs.deploy-landing-ui.result == 'success' ||
       needs.detect-changes.outputs.landing_stack_exists == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run landing E2E tests
        uses: ./.github/actions/run-e2e-tests
        with:
          vertical: landing
          web-url: ${{ needs.deploy-landing-ui.outputs.web_url }}
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

  # ========================================
  # Post-Deployment Summary
  # ========================================

  deploy-insurance-infra:
    name: Deploy Insurance Infra
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.infrastructure_changed == 'true' ||
      needs.detect-changes.outputs.insurance_lambda_changed == 'true' ||
      needs.detect-changes.outputs.insurance_stack_exists == 'false' ||
      inputs.force_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      stack_name: ${{ steps.deploy.outputs.stack_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup infrastructure deployment
        uses: ./.github/actions/setup-infra-deploy
        with:
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

      - name: Deploy insurance stack
        id: deploy
        env:
          STACK_NAME: ${{ needs.detect-changes.outputs.base_stack_name }}
          VERTICAL: insurance
          STAGE_NAME: test-${{ github.run_id }}
        run: |
          echo "Deploying insurance stack: ${STACK_NAME}-insurance"
          chmod +x scripts/deploy-stack.sh
          ./scripts/deploy-stack.sh
          echo "stack_name=${STACK_NAME}-insurance" >> $GITHUB_OUTPUT

  deploy-insurance-ui:
    name: Deploy Insurance UI
    needs: [detect-changes, deploy-insurance-infra]
    if: |
      always() &&
      (needs.detect-changes.outputs.ui_changed == 'true' || needs.detect-changes.outputs.insurance_ui_changed == 'true' || needs.deploy-insurance-infra.result == 'success' || inputs.force_deploy == 'true') &&
      (needs.deploy-insurance-infra.result == 'success' || needs.deploy-insurance-infra.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      api_url: ${{ steps.outputs.outputs.api_url }}
      web_url: ${{ steps.outputs.outputs.web_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Build and deploy insurance UI
        env:
          STACK_NAME: ${{ needs.detect-changes.outputs.base_stack_name }}
          VERTICAL: insurance
        run: |
          chmod +x scripts/deploy-ui.sh
          ./scripts/deploy-ui.sh

      - name: Get stack outputs
        id: outputs
        run: |
          STACK_NAME="${{ needs.detect-changes.outputs.base_stack_name }}-insurance"

          OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_NAME}" \
            --query 'Stacks[0].Outputs' \
            --output json)

          API_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="InsuranceApiUrl") | .OutputValue')
          WEB_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="InsuranceUiBucketWebsiteURL") | .OutputValue')

          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "web_url=${WEB_URL}" >> $GITHUB_OUTPUT

  insurance-tests:
    name: Insurance E2E Tests
    needs: [detect-changes, deploy-insurance-infra, deploy-insurance-ui]
    if: |
      always() &&
      (needs.deploy-insurance-ui.result == 'success' ||
       needs.detect-changes.outputs.insurance_stack_exists == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run insurance E2E tests
        uses: ./.github/actions/run-e2e-tests
        with:
          vertical: insurance
          web-url: ${{ needs.deploy-insurance-ui.outputs.web_url }}
          api-url: ${{ needs.deploy-insurance-ui.outputs.api_url }}
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

  seed-insurance-data:
    name: Seed Insurance Data
    needs: [deploy-insurance-ui, insurance-tests]
    if: |
      always() &&
      needs.deploy-insurance-ui.result == 'success' &&
      (needs.insurance-tests.result == 'success' || needs.insurance-tests.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Seed insurance demo data
        uses: ./.github/actions/clear-and-seed-data
        with:
          api-base-url: ${{ needs.deploy-insurance-ui.outputs.api_url }}
          vertical: insurance

  # ========================================
  # Retail Vertical Pipeline
  # ========================================

  deploy-retail-infra:
    name: Deploy Retail Infra
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.infrastructure_changed == 'true' ||
      needs.detect-changes.outputs.retail_lambda_changed == 'true' ||
      needs.detect-changes.outputs.retail_stack_exists == 'false' ||
      inputs.force_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      stack_name: ${{ steps.deploy.outputs.stack_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup infrastructure deployment
        uses: ./.github/actions/setup-infra-deploy
        with:
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

      - name: Deploy retail stack
        id: deploy
        env:
          STACK_NAME: ${{ needs.detect-changes.outputs.base_stack_name }}
          VERTICAL: retail
          STAGE_NAME: test-${{ github.run_id }}
        run: |
          echo "Deploying retail stack: ${STACK_NAME}-retail"
          chmod +x scripts/deploy-stack.sh
          ./scripts/deploy-stack.sh
          echo "stack_name=${STACK_NAME}-retail" >> $GITHUB_OUTPUT

  deploy-healthcare-infra:
    name: Deploy Healthcare Infra
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.infrastructure_changed == 'true' ||
      needs.detect-changes.outputs.healthcare_lambda_changed == 'true' ||
      needs.detect-changes.outputs.healthcare_stack_exists == 'false' ||
      inputs.force_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      stack_name: ${{ steps.deploy.outputs.stack_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup infrastructure deployment
        uses: ./.github/actions/setup-infra-deploy
        with:
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

      - name: Deploy healthcare stack
        id: deploy
        env:
          STACK_NAME: ${{ needs.detect-changes.outputs.base_stack_name }}
          VERTICAL: healthcare
          STAGE_NAME: test-${{ github.run_id }}
        run: |
          echo "Deploying healthcare stack: ${STACK_NAME}-healthcare"
          chmod +x scripts/deploy-stack.sh
          ./scripts/deploy-stack.sh
          echo "stack_name=${STACK_NAME}-healthcare" >> $GITHUB_OUTPUT

  deploy-retail-ui:
    name: Deploy Retail UI
    needs: [detect-changes, deploy-retail-infra]
    if: |
      always() &&
      (needs.detect-changes.outputs.ui_changed == 'true' || needs.detect-changes.outputs.retail_ui_changed == 'true' || needs.deploy-retail-infra.result == 'success' || inputs.force_deploy == 'true') &&
      (needs.deploy-retail-infra.result == 'success' || needs.deploy-retail-infra.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      api_url: ${{ steps.outputs.outputs.api_url }}
      web_url: ${{ steps.outputs.outputs.web_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Build and deploy retail UI
        env:
          STACK_NAME: ${{ needs.detect-changes.outputs.base_stack_name }}
          VERTICAL: retail
        run: |
          chmod +x scripts/deploy-ui.sh
          ./scripts/deploy-ui.sh

      - name: Get stack outputs
        id: outputs
        run: |
          STACK_NAME="${{ needs.detect-changes.outputs.base_stack_name }}-retail"

          OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_NAME}" \
            --query 'Stacks[0].Outputs' \
            --output json)

          API_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="RetailApiUrl") | .OutputValue')
          WEB_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="RetailUiBucketWebsiteURL") | .OutputValue')

          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "web_url=${WEB_URL}" >> $GITHUB_OUTPUT

  deploy-healthcare-ui:
    name: Deploy Healthcare UI
    needs: [detect-changes, deploy-healthcare-infra]
    if: |
      always() &&
      (needs.detect-changes.outputs.ui_changed == 'true' || needs.detect-changes.outputs.healthcare_ui_changed == 'true' || needs.deploy-healthcare-infra.result == 'success' || inputs.force_deploy == 'true') &&
      (needs.deploy-healthcare-infra.result == 'success' || needs.deploy-healthcare-infra.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      api_url: ${{ steps.outputs.outputs.api_url }}
      web_url: ${{ steps.outputs.outputs.web_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Build and deploy healthcare UI
        env:
          STACK_NAME: ${{ needs.detect-changes.outputs.base_stack_name }}
          VERTICAL: healthcare
        run: |
          chmod +x scripts/deploy-ui.sh
          ./scripts/deploy-ui.sh

      - name: Get stack outputs
        id: outputs
        run: |
          STACK_NAME="${{ needs.detect-changes.outputs.base_stack_name }}-healthcare"

          OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_NAME}" \
            --query 'Stacks[0].Outputs' \
            --output json)

          API_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="HealthcareApiUrl") | .OutputValue')
          WEB_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="HealthcareUiBucketWebsiteURL") | .OutputValue')

          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "web_url=${WEB_URL}" >> $GITHUB_OUTPUT

  healthcare-tests:
    name: Healthcare E2E Tests
    needs: [detect-changes, deploy-healthcare-infra, deploy-healthcare-ui]
    if: |
      always() &&
      (needs.deploy-healthcare-ui.result == 'success' ||
       needs.detect-changes.outputs.healthcare_stack_exists == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run healthcare E2E tests
        uses: ./.github/actions/run-e2e-tests
        with:
          vertical: healthcare
          web-url: ${{ needs.deploy-healthcare-ui.outputs.web_url }}
          api-url: ${{ needs.deploy-healthcare-ui.outputs.api_url }}
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

  seed-healthcare-data:
    name: Seed Healthcare Data
    needs: [deploy-healthcare-ui, healthcare-tests]
    if: |
      always() &&
      needs.deploy-healthcare-ui.result == 'success' &&
      (needs.healthcare-tests.result == 'success' || needs.healthcare-tests.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Seed healthcare demo data
        uses: ./.github/actions/clear-and-seed-data
        with:
          api-base-url: ${{ needs.deploy-healthcare-ui.outputs.api_url }}
          vertical: healthcare

  retail-tests:
    name: Retail E2E Tests
    needs: [detect-changes, deploy-retail-infra, deploy-retail-ui]
    if: |
      always() &&
      (needs.deploy-retail-ui.result == 'success' ||
       needs.detect-changes.outputs.retail_stack_exists == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run retail E2E tests
        uses: ./.github/actions/run-e2e-tests
        with:
          vertical: retail
          web-url: ${{ needs.deploy-retail-ui.outputs.web_url }}
          api-url: ${{ needs.deploy-retail-ui.outputs.api_url }}
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

  seed-retail-data:
    name: Seed Retail Data
    needs: [deploy-retail-ui, retail-tests]
    if: |
      always() &&
      needs.deploy-retail-ui.result == 'success' &&
      (needs.retail-tests.result == 'success' || needs.retail-tests.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Seed retail demo data
        uses: ./.github/actions/clear-and-seed-data
        with:
          api-base-url: ${{ needs.deploy-retail-ui.outputs.api_url }}
          vertical: retail

  # ========================================
  # Fintech Vertical Pipeline
  # ========================================

  deploy-fintech-infra:
    name: Deploy Fintech Infra
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.infrastructure_changed == 'true' ||
      needs.detect-changes.outputs.fintech_lambda_changed == 'true' ||
      needs.detect-changes.outputs.fintech_stack_exists == 'false' ||
      inputs.force_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      stack_name: ${{ steps.deploy.outputs.stack_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup infrastructure deployment
        uses: ./.github/actions/setup-infra-deploy
        with:
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

      - name: Deploy fintech stack
        id: deploy
        env:
          STACK_NAME: ${{ needs.detect-changes.outputs.base_stack_name }}
          VERTICAL: fintech
          STAGE_NAME: test-${{ github.run_id }}
        run: |
          echo "Deploying fintech stack: ${STACK_NAME}-fintech"
          chmod +x scripts/deploy-stack.sh
          ./scripts/deploy-stack.sh
          echo "stack_name=${STACK_NAME}-fintech" >> $GITHUB_OUTPUT

  deploy-fintech-ui:
    name: Deploy Fintech UI
    needs: [detect-changes, deploy-fintech-infra]
    if: |
      always() &&
      (needs.detect-changes.outputs.ui_changed == 'true' || needs.detect-changes.outputs.fintech_ui_changed == 'true' || needs.deploy-fintech-infra.result == 'success' || inputs.force_deploy == 'true') &&
      (needs.deploy-fintech-infra.result == 'success' || needs.deploy-fintech-infra.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      api_url: ${{ steps.outputs.outputs.api_url }}
      web_url: ${{ steps.outputs.outputs.web_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Build and deploy fintech UI
        env:
          STACK_NAME: ${{ needs.detect-changes.outputs.base_stack_name }}
          VERTICAL: fintech
        run: |
          chmod +x scripts/deploy-ui.sh
          ./scripts/deploy-ui.sh

      - name: Get stack outputs
        id: outputs
        run: |
          STACK_NAME="${{ needs.detect-changes.outputs.base_stack_name }}-fintech"

          OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_NAME}" \
            --query 'Stacks[0].Outputs' \
            --output json)

          API_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="FintechApiUrl") | .OutputValue')
          WEB_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="FintechUiBucketWebsiteURL") | .OutputValue')

          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "web_url=${WEB_URL}" >> $GITHUB_OUTPUT

  fintech-tests:
    name: Fintech E2E Tests
    needs: [detect-changes, deploy-fintech-infra, deploy-fintech-ui]
    if: |
      always() &&
      (needs.deploy-fintech-ui.result == 'success' ||
       needs.detect-changes.outputs.fintech_stack_exists == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run fintech E2E tests
        uses: ./.github/actions/run-e2e-tests
        with:
          vertical: fintech
          web-url: ${{ needs.deploy-fintech-ui.outputs.web_url }}
          api-url: ${{ needs.deploy-fintech-ui.outputs.api_url }}
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

  seed-fintech-data:
    name: Seed Fintech Data
    needs: [deploy-fintech-ui, fintech-tests]
    if: |
      always() &&
      needs.deploy-fintech-ui.result == 'success' &&
      (needs.fintech-tests.result == 'success' || needs.fintech-tests.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Seed fintech demo data
        uses: ./.github/actions/clear-and-seed-data
        with:
          api-base-url: ${{ needs.deploy-fintech-ui.outputs.api_url }}
          vertical: fintech

  # ========================================
  # Landing Page Pipeline
  # ========================================

  pr-summary:
    name: Post PR Summary
    needs: [
      detect-changes,
      deploy-insurance-infra,
      deploy-insurance-ui,
      insurance-tests,
      seed-insurance-data,
      deploy-retail-infra,
      deploy-retail-ui,
      retail-tests,
      seed-retail-data,
      deploy-healthcare-infra,
      deploy-healthcare-ui,
      healthcare-tests,
      seed-healthcare-data,
      deploy-fintech-infra,
      deploy-fintech-ui,
      fintech-tests,
      seed-fintech-data,
      deploy-landing-infra,
      deploy-landing-ui,
      landing-tests
    ]
    if: always() && github.event.pull_request.number
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build PR summary comment
        id: summary
        run: |
          cat > /tmp/pr-comment.md <<'EOF'
          ## ðŸš€ Multi-Vertical Test Deployment Summary

          **PR**: #${{ github.event.pull_request.number }}
          **Workflow Run**: [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          EOF

          # Add deployment status table
          cat >> /tmp/pr-comment.md <<EOF
          ### Deployment Status

          | Vertical | Infrastructure | UI | Tests | Data Seeding |
          |----------|---------------|-----|-------|--------------|
          | ðŸ¥ **Insurance** | ${{ needs.deploy-insurance-infra.result == 'success' && 'âœ…' || needs.deploy-insurance-infra.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.deploy-insurance-ui.result == 'success' && 'âœ…' || needs.deploy-insurance-ui.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.insurance-tests.result == 'success' && 'âœ…' || needs.insurance-tests.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.seed-insurance-data.result == 'success' && 'âœ…' || needs.seed-insurance-data.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          | ðŸ›’ **Retail** | ${{ needs.deploy-retail-infra.result == 'success' && 'âœ…' || needs.deploy-retail-infra.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.deploy-retail-ui.result == 'success' && 'âœ…' || needs.deploy-retail-ui.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.retail-tests.result == 'success' && 'âœ…' || needs.retail-tests.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.seed-retail-data.result == 'success' && 'âœ…' || needs.seed-retail-data.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          | ðŸ©º **Healthcare** | ${{ needs.deploy-healthcare-infra.result == 'success' && 'âœ…' || needs.deploy-healthcare-infra.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.deploy-healthcare-ui.result == 'success' && 'âœ…' || needs.deploy-healthcare-ui.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.healthcare-tests.result == 'success' && 'âœ…' || needs.healthcare-tests.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.seed-healthcare-data.result == 'success' && 'âœ…' || needs.seed-healthcare-data.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          | ðŸ  **Landing** | ${{ needs.deploy-landing-infra.result == 'success' && 'âœ…' || needs.deploy-landing-infra.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.deploy-landing-ui.result == 'success' && 'âœ…' || needs.deploy-landing-ui.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.landing-tests.result == 'success' && 'âœ…' || needs.landing-tests.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | N/A |

          EOF

          # Add environment URLs if successful
          INSURANCE_UI_SUCCESS="${{ needs.deploy-insurance-ui.result == 'success' }}"
          RETAIL_UI_SUCCESS="${{ needs.deploy-retail-ui.result == 'success' }}"
          LANDING_UI_SUCCESS="${{ needs.deploy-landing-ui.result == 'success' }}"
          INSURANCE_SEED_SUCCESS="${{ needs.seed-insurance-data.result == 'success' }}"
          RETAIL_SEED_SUCCESS="${{ needs.seed-retail-data.result == 'success' }}"

          if [ "$INSURANCE_UI_SUCCESS" = "true" ] || [ "$RETAIL_UI_SUCCESS" = "true" ] || [ "$LANDING_UI_SUCCESS" = "true" ]; then
            cat >> /tmp/pr-comment.md <<EOF
          ---

          ### ðŸŒ Test Environments

          EOF

            if [ "$INSURANCE_UI_SUCCESS" = "true" ]; then
              INSURANCE_STATUS=""
              if [ "$INSURANCE_SEED_SUCCESS" = "true" ]; then
                INSURANCE_STATUS=" âœ… Ready with demo data"
              else
                INSURANCE_STATUS=" âš ï¸ Deployed (demo data pending)"
              fi
              cat >> /tmp/pr-comment.md <<EOF
          #### ðŸ¥ Insurance Vertical${INSURANCE_STATUS}
          **Web URL:** ${{ needs.deploy-insurance-ui.outputs.web_url }}
          **API URL:** ${{ needs.deploy-insurance-ui.outputs.api_url }}

          EOF
            fi

            if [ "$RETAIL_UI_SUCCESS" = "true" ]; then
              RETAIL_STATUS=""
              if [ "$RETAIL_SEED_SUCCESS" = "true" ]; then
                RETAIL_STATUS=" âœ… Ready with demo data"
              else
                RETAIL_STATUS=" âš ï¸ Deployed (demo data pending)"
              fi
              cat >> /tmp/pr-comment.md <<EOF
          #### ðŸ›’ Retail Vertical${RETAIL_STATUS}
          **Web URL:** ${{ needs.deploy-retail-ui.outputs.web_url }}
          **API URL:** ${{ needs.deploy-retail-ui.outputs.api_url }}

          EOF
            fi

            if [ "$LANDING_UI_SUCCESS" = "true" ]; then
              cat >> /tmp/pr-comment.md <<EOF
          #### ðŸ  Landing Page âœ… Ready
          **Web URL:** ${{ needs.deploy-landing-ui.outputs.web_url }}

          EOF
            fi
          fi

          # Add failure notice if any failures
          if [ "${{ needs.deploy-insurance-infra.result }}" = "failure" ] || \
             [ "${{ needs.deploy-insurance-ui.result }}" = "failure" ] || \
             [ "${{ needs.insurance-tests.result }}" = "failure" ] || \
             [ "${{ needs.deploy-retail-infra.result }}" = "failure" ] || \
             [ "${{ needs.deploy-retail-ui.result }}" = "failure" ] || \
             [ "${{ needs.retail-tests.result }}" = "failure" ] || \
             [ "${{ needs.deploy-landing-infra.result }}" = "failure" ] || \
             [ "${{ needs.deploy-landing-ui.result }}" = "failure" ] || \
             [ "${{ needs.landing-tests.result }}" = "failure" ]; then
            cat >> /tmp/pr-comment.md <<EOF
          ---

          âš ï¸ **Some deployments or tests failed.** Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
          EOF
          fi

          echo "comment_file=/tmp/pr-comment.md" >> $GITHUB_OUTPUT

      - name: Post comment to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const commentBody = fs.readFileSync('/tmp/pr-comment.md', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });

