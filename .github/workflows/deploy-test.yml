name: Deploy Test Stack

on:
  pull_request:
    branches: [main]
    paths:
      - 'cdk/**'
      - 'lambda/**'
      - 'ui/**'
      - 'tests/**'
      - 'scripts/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number for stack naming (optional)'
        required: false
      force_deploy:
        description: 'Force stack deployment even if no changes detected'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  id-token: write
  contents: read
  pull-requests: read

jobs:
  detect-changes:
    name: Detect Changed Files
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # Required to post comment
      id-token: write      # Required for AWS
    outputs:
      infrastructure_changed: ${{ steps.filter.outputs.infrastructure }}
      ui_changed: ${{ steps.filter.outputs.ui }}
      tests_changed: ${{ steps.filter.outputs.tests }}
      stack_exists: ${{ steps.check-stack.outputs.stack_exists }}
    steps:
      - name: Post workflow start comment
        if: github.event.pull_request.number
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ðŸš€ **Test deployment started**\n\n[View workflow run â†’](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            });

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            infrastructure:
              - 'cdk/**'
              - 'lambda/**'
              - 'scripts/deploy-stack.sh'
            ui:
              - 'ui/**'
              - 'scripts/generate-architecture-diagram.py'
              - 'scripts/deploy-ui.sh'
            tests:
              - 'tests/**'
              - '.github/workflows/deploy-test.yml'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Check if test stack exists
        id: check-stack
        run: |
          STACK_NAME=$(./scripts/ci/get-stack-name.sh "${{ github.event.pull_request.number || inputs.pr_number }}" "${{ github.run_id }}")
          ./scripts/ci/check-stack-status.sh "${STACK_NAME}"

  deploy-stack:
    name: Deploy Infra
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.infrastructure_changed == 'true' ||
      needs.detect-changes.outputs.stack_exists == 'false' ||
      inputs.force_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 25

    outputs:
      stack_name: ${{ steps.stack-name.outputs.stack_name }}
      stack_status: ${{ steps.check-stack.outputs.stack_status }}
      stack_deleted: ${{ steps.check-stack.outputs.stack_deleted }}
      skip_deploy: ${{ steps.check-deployment.outputs.skip_deploy || 'false' }}
      skip_reason: ${{ steps.check-deployment.outputs.skip_reason || '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Determine test stack name
        id: stack-name
        run: |
          STACK_NAME=$(./scripts/ci/get-stack-name.sh "${{ github.event.pull_request.number || inputs.pr_number }}" "${{ github.run_id }}")
          echo "stack_name=${STACK_NAME}" >> $GITHUB_OUTPUT
          echo "Test stack name: ${STACK_NAME}"

      - name: Check if CDK stack exists
        id: check-stack
        run: ./scripts/ci/check-stack-status.sh "${{ steps.stack-name.outputs.stack_name }}"

      - name: Setup AWS CDK
        uses: ./.github/actions/setup-aws-cdk

      - name: Check if infrastructure changes require deployment
        id: check-deployment
        if: |
          needs.detect-changes.outputs.infrastructure_changed != 'true' &&
          steps.check-stack.outputs.stack_status != 'NOT_FOUND' &&
          inputs.force_deploy != 'true'
        run: |
          echo "No infrastructure file changes detected. Checking CDK diff..."

          cd cdk

          # Run cdk diff to check for actual changes
          if cdk diff "${{ steps.stack-name.outputs.stack_name }}" > /tmp/cdk-diff.txt 2>&1; then
            DIFF_EXIT=$?

            if [ $DIFF_EXIT -eq 0 ]; then
              echo "âœ“ CDK diff shows no changes - deployment can be skipped"
              echo "skip_deploy=true" >> $GITHUB_OUTPUT
              echo "skip_reason=No infrastructure changes detected" >> $GITHUB_OUTPUT
            else
              echo "âš  CDK diff detected changes despite no file changes (possibly parameter updates)"
              echo "skip_deploy=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš  CDK diff failed - will deploy to be safe"
            echo "skip_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate CDK stacks (synth)
        if: |
          needs.detect-changes.outputs.infrastructure_changed == 'true' ||
          steps.check-stack.outputs.stack_status == 'NOT_FOUND'
        env:
          STACK_NAME: ${{ steps.stack-name.outputs.stack_name }}
          STAGE_NAME: test
          CREATE_CLOUDFRONT: "false"
          DOMAIN_NAME: ""
        run: |
          echo "Validating CDK stacks via synthesis..."
          cd cdk
          cdk synth ${{ steps.stack-name.outputs.stack_name }} > /dev/null
          echo "âœ… CDK stack synthesis successful"

      - name: Bootstrap CDK
        if: steps.check-deployment.outputs.skip_deploy != 'true'
        uses: ./.github/actions/bootstrap-cdk

      - name: Deploy test stack
        if: steps.check-deployment.outputs.skip_deploy != 'true'
        env:
          STACK_NAME: ${{ steps.stack-name.outputs.stack_name }}
          APP_NAME: silvermoat-test
          STAGE_NAME: test
          UI_SEEDING_MODE: external
          CREATE_CLOUDFRONT: false
          DOMAIN_NAME: ""
        run: |
          echo "Deploying test stack: ${STACK_NAME}"
          chmod +x scripts/deploy-stack.sh
          ./scripts/deploy-stack.sh

  deploy-ui:
    name: Deploy UI
    needs: [detect-changes, deploy-stack]
    if: |
      always() &&
      (needs.deploy-stack.result == 'success' || needs.deploy-stack.result == 'skipped') &&
      (needs.deploy-stack.result == 'success' || needs.detect-changes.outputs.ui_changed == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      stack_name: ${{ steps.stack-name.outputs.stack_name }}
      api_url: ${{ steps.stack-outputs.outputs.api_url }}
      web_url: ${{ steps.stack-outputs.outputs.web_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Determine stack name
        id: stack-name
        run: |
          # Use output from deploy-stack if available, otherwise recalculate
          if [ "${{ needs.deploy-stack.result }}" = "success" ]; then
            STACK_NAME="${{ needs.deploy-stack.outputs.stack_name }}"
          else
            # Recalculate (same logic as deploy-stack)
            if [ -n "${{ github.event.pull_request.number }}" ]; then
              STACK_NAME="silvermoat-test-pr-${{ github.event.pull_request.number }}"
            elif [ -n "${{ inputs.pr_number }}" ]; then
              STACK_NAME="silvermoat-test-pr-${{ inputs.pr_number }}"
            else
              STACK_NAME="silvermoat-test-${{ github.run_id }}"
            fi
          fi
          echo "stack_name=${STACK_NAME}" >> $GITHUB_OUTPUT
          echo "Stack name: ${STACK_NAME}"

      - name: Build and deploy React UI
        env:
          STACK_NAME: ${{ steps.stack-name.outputs.stack_name }}
        run: |
          echo "Building and deploying React UI..."
          chmod +x scripts/deploy-ui.sh
          ./scripts/deploy-ui.sh

      - name: Get stack outputs
        id: stack-outputs
        run: |
          STACK_NAME="${{ steps.stack-name.outputs.stack_name }}"

          # Get all outputs as JSON
          OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_NAME}" \
            --query 'Stacks[0].Outputs' \
            --output json)

          # Extract specific outputs
          API_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="ApiBaseUrl") | .OutputValue')

          # Try CloudFrontUrl first (production), fall back to WebUrl (test stacks)
          WEB_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="CloudFrontUrl") | .OutputValue')
          if [ -z "$WEB_URL" ] || [ "$WEB_URL" == "null" ]; then
            WEB_URL=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="WebUrl") | .OutputValue')
          fi

          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "web_url=${WEB_URL}" >> $GITHUB_OUTPUT

          echo "API URL: ${API_URL}"
          echo "Web URL: ${WEB_URL}"

  tests:
    name: Tests
    needs: [deploy-stack, deploy-ui]
    if: always() && needs.deploy-ui.result == 'success'
    uses: ./.github/workflows/test-suite.yml
    with:
      stack_name: ${{ needs.deploy-ui.outputs.stack_name || needs.deploy-stack.outputs.stack_name }}
      api_url: ${{ needs.deploy-ui.outputs.api_url }}
      web_url: ${{ needs.deploy-ui.outputs.web_url }}
      environment: 'test'
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  clear-and-seed-data:
    name: Seed Demo Data
    needs: [deploy-stack, deploy-ui, tests]
    if: |
      always() &&
      (needs.deploy-stack.result == 'success' || needs.deploy-stack.result == 'skipped') &&
      needs.deploy-ui.result == 'success' &&
      needs.tests.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clear and seed demo data
        uses: ./.github/actions/clear-and-seed-data
        with:
          api-base-url: ${{ needs.deploy-ui.outputs.api_url }}

  pr-summary:
    name: Post PR Summary
    needs: [detect-changes, deploy-stack, deploy-ui, tests, clear-and-seed-data]
    if: always() && github.event.pull_request.number
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build PR summary comment
        id: summary
        run: |
          cat > /tmp/pr-comment.md <<'EOF'
          ## ðŸš€ Test Deployment Summary

          **PR**: #${{ github.event.pull_request.number }}
          **Workflow Run**: [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          EOF

          # Add prominent Web URL box if deployment succeeded
          UI_RESULT="${{ needs.deploy-ui.result }}"
          SEED_RESULT="${{ needs.clear-and-seed-data.result }}"
          if [ "$UI_RESULT" = "success" ] && [ "$SEED_RESULT" = "success" ]; then
            cat >> /tmp/pr-comment.md <<EOF
          ---

          ### ðŸŒ **Test Environment Ready**

          **Web URL:** ${{ needs.deploy-ui.outputs.web_url }}

          **API URL:** ${{ needs.deploy-ui.outputs.api_url }}

          Demo data has been seeded. You can now test your changes!

          ---
          EOF
          fi

          cat >> /tmp/pr-comment.md <<'EOF'

          ### ðŸ“¦ Infrastructure Deployment
          EOF

          # Stack deployment status
          STACK_RESULT="${{ needs.deploy-stack.result }}"
          if [ "$STACK_RESULT" = "success" ]; then
            echo "âœ… **Deployed** - Stack deployed successfully" >> /tmp/pr-comment.md
            echo "- Stack: \`${{ needs.deploy-stack.outputs.stack_name }}\`" >> /tmp/pr-comment.md
          elif [ "$STACK_RESULT" = "skipped" ]; then
            SKIP_REASON="${{ needs.deploy-stack.outputs.skip_reason }}"
            if [ -z "$SKIP_REASON" ]; then
              SKIP_REASON="No infrastructure changes detected"
            fi
            echo "â­ï¸ **Skipped** - ${SKIP_REASON}" >> /tmp/pr-comment.md
          elif [ "$STACK_RESULT" = "failure" ]; then
            echo "âŒ **Failed** - Stack deployment failed" >> /tmp/pr-comment.md
          else
            echo "âš ï¸ **${STACK_RESULT}** - Unexpected status" >> /tmp/pr-comment.md
          fi

          cat >> /tmp/pr-comment.md <<'EOF'

          ### ðŸŽ¨ UI Deployment
          EOF

          # UI deployment status
          UI_RESULT="${{ needs.deploy-ui.result }}"
          if [ "$UI_RESULT" = "success" ]; then
            echo "âœ… **Deployed** - UI built and deployed successfully" >> /tmp/pr-comment.md
          elif [ "$UI_RESULT" = "skipped" ]; then
            echo "â­ï¸ **Skipped** - UI deployment was skipped" >> /tmp/pr-comment.md
          elif [ "$UI_RESULT" = "failure" ]; then
            echo "âŒ **Failed** - UI deployment failed" >> /tmp/pr-comment.md
            echo "- Web URL: ${{ needs.deploy-ui.outputs.web_url }}" >> /tmp/pr-comment.md
            echo "- API URL: ${{ needs.deploy-ui.outputs.api_url }}" >> /tmp/pr-comment.md
          else
            echo "âš ï¸ **${UI_RESULT}** - Unexpected status" >> /tmp/pr-comment.md
          fi

          cat >> /tmp/pr-comment.md <<'EOF'

          ### ðŸ§ª Tests
          EOF

          # Test results
          TESTS_RESULT="${{ needs.tests.result }}"
          if [ "$TESTS_RESULT" = "success" ]; then
            echo "âœ… **Passed** - All tests passed" >> /tmp/pr-comment.md
          elif [ "$TESTS_RESULT" = "failure" ]; then
            echo "âŒ **Failed** - Some tests failed (see workflow details)" >> /tmp/pr-comment.md
          elif [ "$TESTS_RESULT" = "skipped" ]; then
            echo "â­ï¸ **Skipped** - Tests were skipped" >> /tmp/pr-comment.md
          else
            echo "âš ï¸ **${TESTS_RESULT}** - Unexpected status" >> /tmp/pr-comment.md
          fi

          cat >> /tmp/pr-comment.md <<'EOF'

          ### ðŸŒ± Demo Data Seeding
          EOF

          # Data seeding status
          SEED_RESULT="${{ needs.clear-and-seed-data.result }}"
          if [ "$SEED_RESULT" = "success" ]; then
            echo "âœ… **Completed** - Demo data seeded successfully" >> /tmp/pr-comment.md
          elif [ "$SEED_RESULT" = "skipped" ]; then
            echo "â­ï¸ **Skipped** - Data seeding was skipped" >> /tmp/pr-comment.md
          elif [ "$SEED_RESULT" = "failure" ]; then
            echo "âŒ **Failed** - Data seeding failed" >> /tmp/pr-comment.md
          else
            echo "âš ï¸ **${SEED_RESULT}** - Unexpected status" >> /tmp/pr-comment.md
          fi

          cat >> /tmp/pr-comment.md <<'EOF'

          ---

          <sub>ðŸ¤– Auto-generated summary from test deployment workflow</sub>
          EOF

          echo "Generated comment:"
          cat /tmp/pr-comment.md

      - name: Post comment to PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/pr-comment.md
